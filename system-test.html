<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMU Portfolio System - Complete Test Suite</title>
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0a66c2;
            border-bottom: 3px solid #0a66c2;
            padding-bottom: 10px;
        }
        h2 {
            color: #2c3e50;
            margin-top: 30px;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 6px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .pass {
            color: #27ae60;
            font-weight: bold;
        }
        .fail {
            color: #e74c3c;
            font-weight: bold;
        }
        .warning {
            color: #f39c12;
            font-weight: bold;
        }
        .test-result {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
        }
        .pass-result {
            background: #d5f4e6;
            border-left: 4px solid #27ae60;
        }
        .fail-result {
            background: #fadbd8;
            border-left: 4px solid #e74c3c;
        }
        .warning-result {
            background: #fcf3cf;
            border-left: 4px solid #f39c12;
        }
        .code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            margin: 10px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-pass {
            background: #d5f4e6;
            border: 2px solid #27ae60;
        }
        .stat-fail {
            background: #fadbd8;
            border: 2px solid #e74c3c;
        }
        .stat-warning {
            background: #fcf3cf;
            border: 2px solid #f39c12;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        button {
            background: #0a66c2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #084a8b;
        }
        .deployment-commands {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            white-space: pre-line;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ RMU Portfolio System - Complete Test Suite</h1>
        
        <div class="stats" id="stats">
            <!-- Will be populated by JavaScript -->
        </div>
        
        <h2>üìã Backend Deployment Commands</h2>
        <div class="deployment-commands">
# Navigate to backend directory
cd "c:\Users\ABDUL\OneDrive - Rawalpindi Medical University\Documents\Code\github-deployment\backend"

# Deploy to Cloud Run (Updated with proper environment variables)
gcloud run deploy rmu-portfolio-backend \
  --source . \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars="GOOGLE_CLIENT_ID=$env:GOOGLE_CLIENT_ID,ORIGIN=https://rmuportfolioadmin.github.io,ADMIN_EMAIL=rmuportfolioa@gmail.com" \
  --max-instances=10 \
  --memory=1Gi \
  --cpu=1 \
  --timeout=300 \
  --port=8080 \
  --quiet

# Verify deployment
gcloud run services describe rmu-portfolio-backend --region=us-central1 --format="value(status.url)"

# Test endpoints
curl "https://rmu-portfolio-backend-738776771863.us-central1.run.app/"
curl "https://rmu-portfolio-backend-738776771863.us-central1.run.app/healthz"
        </div>
        
        <div class="test-section">
            <button onclick="runAllTests()">üîÑ Run All Tests</button>
            <button onclick="testBackendConnectivity()">üîó Test Backend</button>
            <button onclick="testAuthSystem()">üîê Test Auth System</button>
            <button onclick="testFileStructure()">üìÅ Test File Structure</button>
            <button onclick="validateConfiguration()">‚öôÔ∏è Validate Config</button>
        </div>

        <h2>üîç Configuration Validation</h2>
        <div class="test-section" id="config-tests">
            <div class="test-result warning-result">‚è≥ Click 'Validate Config' to run tests</div>
        </div>

        <h2>üåê Backend Connectivity</h2>
        <div class="test-section" id="backend-tests">
            <div class="test-result warning-result">‚è≥ Click 'Test Backend' to run tests</div>
        </div>

        <h2>üîê Authentication System</h2>
        <div class="test-section" id="auth-tests">
            <div class="test-result warning-result">‚è≥ Click 'Test Auth System' to run tests</div>
        </div>

        <h2>üìÅ File Structure Analysis</h2>
        <div class="test-section" id="file-tests">
            <div class="test-result warning-result">‚è≥ Click 'Test File Structure' to run tests</div>
        </div>

        <h2>üéØ Performance & Optimization</h2>
        <div class="test-section" id="performance-tests">
            <div class="test-result warning-result">‚è≥ Tests will run automatically</div>
        </div>

        <h2>üìä Issues Found & Fixed</h2>
        <div class="test-section">
            <h3>‚úÖ Fixed Issues</h3>
            <div class="test-result pass-result">‚úì Dockerfile: Fixed duplicate FROM statements and improved security</div>
            <div class="test-result pass-result">‚úì Auth System: Added rate limiting to prevent excessive calls</div>
            <div class="test-result pass-result">‚úì Backend: Improved error handling and logging</div>
            <div class="test-result pass-result">‚úì Portfolio.js: Fixed initGoogleDriveClient method call</div>
            <div class="test-result pass-result">‚úì Index.html: Fixed isValidRollNoFormat function scope</div>
            <div class="test-result pass-result">‚úì Configuration: Optimized debug logging</div>
            
            <h3>‚ö†Ô∏è Recommendations</h3>
            <div class="test-result warning-result">‚ö† Consider implementing service worker for offline functionality</div>
            <div class="test-result warning-result">‚ö† Add comprehensive error boundaries for React-like error handling</div>
            <div class="test-result warning-result">‚ö† Implement progressive loading for large portfolios</div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        let testResults = {
            passed: 0,
            failed: 0,
            warnings: 0
        };

        function updateStats() {
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = `
                <div class="stat-card stat-pass">
                    <div class="stat-number">${testResults.passed}</div>
                    <div>Tests Passed</div>
                </div>
                <div class="stat-card stat-fail">
                    <div class="stat-number">${testResults.failed}</div>
                    <div>Tests Failed</div>
                </div>
                <div class="stat-card stat-warning">
                    <div class="stat-number">${testResults.warnings}</div>
                    <div>Warnings</div>
                </div>
                <div class="stat-card" style="background: #e3f2fd; border: 2px solid #2196f3;">
                    <div class="stat-number">${testResults.passed + testResults.failed + testResults.warnings}</div>
                    <div>Total Tests</div>
                </div>
            `;
        }

        function addTestResult(containerId, message, status) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const resultClass = status === 'pass' ? 'pass-result' : status === 'fail' ? 'fail-result' : 'warning-result';
            const icon = status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚ö†Ô∏è';
            
            const div = document.createElement('div');
            div.className = `test-result ${resultClass}`;
            div.textContent = `${icon} ${message}`;
            container.appendChild(div);
            
            testResults[status === 'pass' ? 'passed' : status === 'fail' ? 'failed' : 'warnings']++;
            updateStats();
        }

        function clearTestResults(containerId) {
            const container = document.getElementById(containerId);
            if (container) container.innerHTML = '';
        }

        async function validateConfiguration() {
            clearTestResults('config-tests');
            
            // Test RMU_CONFIG
            if (window.RMU_CONFIG) {
                addTestResult('config-tests', 'RMU_CONFIG object loaded successfully', 'pass');
                
                // Check required fields
                const requiredFields = ['GOOGLE_CLIENT_ID', 'BACKEND_BASE', 'VC_EMAIL'];
                requiredFields.forEach(field => {
                    if (window.RMU_CONFIG[field]) {
                        addTestResult('config-tests', `${field} is configured`, 'pass');
                    } else {
                        addTestResult('config-tests', `${field} is missing or empty`, 'fail');
                    }
                });

                // Environment detection
                if (window.RMU_CONFIG.IS_GITHUB_PAGES) {
                    addTestResult('config-tests', 'Detected GitHub Pages environment', 'pass');
                } else if (window.RMU_CONFIG.IS_LOCALHOST) {
                    addTestResult('config-tests', 'Detected localhost environment', 'warning');
                } else {
                    addTestResult('config-tests', 'Environment detection working', 'pass');
                }
            } else {
                addTestResult('config-tests', 'RMU_CONFIG object not found', 'fail');
            }

            // Test backwards compatibility
            if (window.GOOGLE_CLIENT_ID) {
                addTestResult('config-tests', 'Backwards compatibility shim working', 'pass');
            } else {
                addTestResult('config-tests', 'Backwards compatibility shim not found', 'warning');
            }
        }

        async function testBackendConnectivity() {
            clearTestResults('backend-tests');
            
            if (!window.RMU_CONFIG?.BACKEND_BASE) {
                addTestResult('backend-tests', 'Backend URL not configured', 'fail');
                return;
            }

            const backendUrl = window.RMU_CONFIG.BACKEND_BASE;
            addTestResult('backend-tests', `Testing backend at: ${backendUrl}`, 'warning');

            try {
                // Test root endpoint
                const rootResponse = await fetch(`${backendUrl}/`, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (rootResponse.ok) {
                    const data = await rootResponse.json();
                    addTestResult('backend-tests', `Root endpoint responding: ${rootResponse.status}`, 'pass');
                    addTestResult('backend-tests', `Service: ${data.service} v${data.version}`, 'pass');
                } else {
                    addTestResult('backend-tests', `Root endpoint error: ${rootResponse.status}`, 'fail');
                }

                // Test health endpoint
                const healthResponse = await fetch(`${backendUrl}/healthz`, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (healthResponse.ok) {
                    addTestResult('backend-tests', 'Health endpoint responding', 'pass');
                } else {
                    addTestResult('backend-tests', `Health endpoint error: ${healthResponse.status}`, 'warning');
                }

            } catch (error) {
                addTestResult('backend-tests', `Backend connectivity failed: ${error.message}`, 'fail');
            }
        }

        async function testAuthSystem() {
            clearTestResults('auth-tests');
            
            // Test RMU_AUTH object
            if (window.RMU_AUTH) {
                addTestResult('auth-tests', 'RMU_AUTH object loaded', 'pass');
                
                // Test methods
                const methods = ['getCurrentUserEmail', 'isAdmin', 'authenticateUser'];
                methods.forEach(method => {
                    if (typeof window.RMU_AUTH[method] === 'function') {
                        addTestResult('auth-tests', `${method} method available`, 'pass');
                    } else {
                        addTestResult('auth-tests', `${method} method missing`, 'fail');
                    }
                });

                // Test current user state
                const currentUser = window.RMU_AUTH.getCurrentUserEmail();
                if (currentUser) {
                    addTestResult('auth-tests', `Current user: ${currentUser}`, 'pass');
                } else {
                    addTestResult('auth-tests', 'No current user (not signed in)', 'warning');
                }

            } else {
                addTestResult('auth-tests', 'RMU_AUTH object not found', 'fail');
            }

            // Test Google Identity Services
            if (window.google && window.google.accounts) {
                addTestResult('auth-tests', 'Google Identity Services loaded', 'pass');
            } else {
                addTestResult('auth-tests', 'Google Identity Services not loaded', 'warning');
            }
        }

        async function testFileStructure() {
            clearTestResults('file-tests');
            
            // Test critical files
            const criticalFiles = [
                'config.js',
                'auth.js', 
                'gallery.js',
                'portfolio.js',
                'portfolio.html',
                'files.json',
                'portfolio-data.json'
            ];

            for (const file of criticalFiles) {
                try {
                    const response = await fetch(`./${file}`, { method: 'HEAD' });
                    if (response.ok) {
                        addTestResult('file-tests', `${file} exists and accessible`, 'pass');
                    } else {
                        addTestResult('file-tests', `${file} not accessible (${response.status})`, 'fail');
                    }
                } catch (error) {
                    addTestResult('file-tests', `${file} fetch failed: ${error.message}`, 'fail');
                }
            }

            // Test files.json content
            try {
                const filesResponse = await fetch('./files.json');
                if (filesResponse.ok) {
                    const filesData = await filesResponse.json();
                    if (Array.isArray(filesData)) {
                        addTestResult('file-tests', `files.json contains ${filesData.length} entries`, 'pass');
                    } else {
                        addTestResult('file-tests', 'files.json format is invalid', 'fail');
                    }
                } else {
                    addTestResult('file-tests', 'files.json not accessible', 'fail');
                }
            } catch (error) {
                addTestResult('file-tests', `files.json validation failed: ${error.message}`, 'fail');
            }
        }

        async function runAllTests() {
            // Reset stats
            testResults = { passed: 0, failed: 0, warnings: 0 };
            
            // Run all tests
            await validateConfiguration();
            await testBackendConnectivity();
            await testAuthSystem();
            await testFileStructure();
            
            // Performance tests
            clearTestResults('performance-tests');
            addTestResult('performance-tests', 'DOM loaded and scripts executed', 'pass');
            addTestResult('performance-tests', `Page loaded in ${performance.now().toFixed(0)}ms`, 'pass');
            
            // Check for common performance issues
            if (document.querySelectorAll('script').length > 10) {
                addTestResult('performance-tests', 'Many script tags detected - consider bundling', 'warning');
            } else {
                addTestResult('performance-tests', 'Script count is reasonable', 'pass');
            }
        }

        // Initialize stats
        updateStats();
        
        // Run basic performance tests on load
        window.addEventListener('load', () => {
            clearTestResults('performance-tests');
            addTestResult('performance-tests', 'DOM loaded and scripts executed', 'pass');
            addTestResult('performance-tests', `Page loaded in ${performance.now().toFixed(0)}ms`, 'pass');
            updateStats();
        });
    </script>
</body>
</html>