<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager, RMU</title>
    <meta name="description" content="Professional medical portfolio of Abdul Haseeb Ahmad, MBBS student specializing in internal medicine and cardiology.">
        <!-- Cache hard disable (defensive; dynamic query params already used) -->
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
    <link rel="stylesheet" href="portfolio.css?v=20250930.1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <style>
            /* Respect user motion preference: disable non-critical animations */
            @media (prefers-reduced-motion: reduce) {
                *, *::before, *::after { animation: none !important; transition: none !important; }
            }
        </style>
        <script src="https://apis.google.com/js/api.js"></script>
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <script>
    console.log("Google API script tag loaded!");
</script>
        <script src="config.js" defer></script>
        <script src="auth.js" defer></script>
</head>
<body class="theme-rmu loading-initial">
    <!-- Back to Gallery Button (conditionally hidden) -->
    <a id="back-to-gallery" class="back-to-gallery" href="index.html" onclick="try{localStorage.clear();sessionStorage.clear();}catch(e){}if(history.length>1){history.back();return false;}" style="position:fixed;left:10px;top:10px;z-index:10000;background:linear-gradient(90deg,#0a66c2,#2b79ff);color:#fff;padding:8px 14px;border-radius:24px;font-size:13px;font-weight:600;text-decoration:none;box-shadow:0 4px 12px -2px rgba(10,70,150,.35);display:inline-flex;align-items:center;gap:6px;">
        <span style="display:inline-block;transform:translateY(1px);">&#8592;</span> Gallery
    </a>
    
    <!-- Gallery Navigation Control Script -->
    <script>
    (function() {
        function getParam(name) {
            try { return new URLSearchParams(location.search).get(name); } catch(e) { return null; }
        }
        
        const welcomeMode = getParam('welcome');
        const userMode = getParam('user');
        const driveMode = getParam('drive');
        const adminMode = getParam('admin');
        
        // Hide gallery button for non-admin authenticated users or welcome mode
        if(welcomeMode || (userMode && !adminMode)) {
            console.log('[Portfolio] Hiding gallery navigation (welcome or user mode)');
            const galleryBtn = document.getElementById('back-to-gallery');
            if(galleryBtn) {
                galleryBtn.style.display = 'none';
            }
            // Also add body class for additional hiding
            document.body.classList.add('hide-gallery-nav');
        }
        
        // Listen for authentication updates from parent window
        window.addEventListener('message', function(event) {
            if(event.data && event.data.type === 'user-portfolio-data') {
                console.log('[Portfolio] Received user portfolio data from Drive');
                if(window.app && typeof window.app.loadUserPortfolioData === 'function') {
                    window.app.loadUserPortfolioData(event.data.data);
                } else {
                    window.__USER_PORTFOLIO_DATA = event.data.data;
                    window.__USER_EMAIL = event.data.email;
                }
            } else if(event.data && event.data.type === 'admin-portfolio-data') {
                console.log('[Portfolio] Received admin portfolio data from parent');
                try {
                    if(event.source && event.source !== window) {
                        event.source.postMessage({ type: 'admin-data-received', success: true }, '*');
                    }
                } catch(e) { console.warn('[Portfolio] Could not send confirmation to parent:', e); }
                if(window.app && typeof window.app.normalizeLoadedData === 'function') {
                    const normalized = window.app.normalizeLoadedData(event.data.data);
                    window.app.loadDataDirectly(normalized);
                    try { const pre = document.getElementById('preload-status'); if(pre) pre.remove(); } catch(_){ }
                    window.__ADOPTED_SPECIFIC_PORTFOLIO = true;
                    try { localStorage.setItem('__lastPortfolioFile', 'admin-remote'); }catch(_){ }
                } else {
                    window.__ADMIN_PORTFOLIO_DATA = event.data.data;
                    window.__ADMIN_FILENAME = event.data.filename;
                }
            }
        });
        
        // Check for user data from sessionStorage (when navigated from index.html)
        function checkUserMode() {
            try {
                const isUserMode = sessionStorage.getItem('isUserMode');
                const userToken = sessionStorage.getItem('userToken');
                const userEmail = sessionStorage.getItem('userEmail');
                const userPortfolioData = sessionStorage.getItem('userPortfolioData');
                
                if(isUserMode === 'true' && userEmail) {
                    console.log('[Portfolio] User mode detected:', userEmail);
                    window.__USER_EMAIL = userEmail;
                    window.__USER_TOKEN = userToken;
                    window.__IS_USER_MODE = true;
                    if(userPortfolioData) {
                        try {
                            const portfolioData = JSON.parse(userPortfolioData);
                            window.__USER_PORTFOLIO_DATA = portfolioData;
                            console.log('[Portfolio] User portfolio data loaded from sessionStorage');
                        } catch(e) {
                            console.error('[Portfolio] Failed to parse user portfolio data:', e);
                        }
                    }
                    document.body.classList.add('user-authenticated');
                    document.body.classList.add('signed-in');
                    try { document.dispatchEvent(new CustomEvent('auth-state-changed', { detail: { signedIn: true, email: userEmail } })); } catch(_) {}
                    if (!userPortfolioData && userToken) {
                        console.log('[Portfolio] No portfolio data in sessionStorage, will attempt auto-load from Drive once app is ready');
                        window.__AUTO_LOAD_FROM_DRIVE = true;
                    }
                    try { sessionStorage.removeItem('userPortfolioData'); } catch(e) { console.warn('[Portfolio] Could not clean sessionStorage:', e); }
                }
            } catch(e) { console.warn('[Portfolio] Error checking user mode:', e); }
        }
        
        checkUserMode();
        document.addEventListener('DOMContentLoaded', checkUserMode);
    })();
    </script>
    <script>
    function isValidRollNoFormat(rollNo) {
        if (!rollNo || typeof rollNo !== 'string') { return false; }
        const rollNoPattern = /^\d{3}-R\d{2}-[A-Z]$/;
        const normalizedInput = rollNo.trim().toUpperCase();
        return rollNoPattern.test(normalizedInput);
    }

    (function(){
        function getParam(name){
            try { return new URLSearchParams(location.search).get(name); } catch(e){ return null; }
        }
        const file = getParam('file');
        if(!file) return;
        try {
            const qp = new URLSearchParams(location.search);
            const isUserMode = qp.get('user') === '1';
            let preserved = {};
            const preserveKeys = ['isUserMode','userEmail','userToken','userPortfolioData'];
            if (isUserMode) { try { preserveKeys.forEach(k => preserved[k] = sessionStorage.getItem(k)); } catch(_) {} }
            try { delete window.__PRELOADED_PORTFOLIO_DATA; } catch(_) {}
            try { delete window.app; } catch(_) {}
            try { sessionStorage.clear(); } catch(_) {}
            if (isUserMode) { try { preserveKeys.forEach(k => { if (preserved[k] !== null && preserved[k] !== undefined) sessionStorage.setItem(k, preserved[k]); }); } catch(_) {} }
        } catch(e) { }
        window.__LOADING_SPECIFIC_FILE = true;
        window.__CURRENT_PORTFOLIO_FILE = file;
        const pre = document.createElement('div');
        pre.id = 'preload-status';
        pre.textContent = `Loading ${file.replace('data/', '')}...`;
        pre.style.cssText = 'position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:18px 30px;border:1px solid #c9d4e2;border-radius:18px;font:600 14px Inter,system-ui,sans-serif;z-index:10001;box-shadow:0 8px 32px -8px rgba(0,0,0,.25);letter-spacing:.5px;';
        document.addEventListener('DOMContentLoaded',()=>{ document.body.appendChild(pre); document.querySelectorAll('.section').forEach(s=>{ s.style.visibility='hidden'; }); });
        const cacheBuster = Date.now();
        const fileUrl = file.includes('?') ? `${file}&cb=${cacheBuster}` : `${file}?cb=${cacheBuster}`;
        const isAdminMode = /(^|[?&])admin=1(&|$)/.test(location.search);
        const isRemoteMode = /(^|[?&])remote=1(&|$)/.test(location.search);
        const overallTimeout = setTimeout(() => {
            const pre = document.getElementById('preload-status');
            if (pre) { pre.textContent = 'File not found - Loading default portfolio...'; pre.style.background = '#fff4e6'; }
            if(!(isAdminMode && isRemoteMode)){ setTimeout(() => { window.location.href = 'portfolio.html?file=portfolio-data.json'; }, 2000); }
        }, 15000);
        (function fetchWithRetry(url, attempt=1){
            const controller = new AbortController();
            const fetchTimeout = setTimeout(() => controller.abort(), 8000);
            fetch(url, { cache:'no-store', signal: controller.signal, headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate','Pragma': 'no-cache','Expires': '0' } })
            .then(r=>{ clearTimeout(fetchTimeout); clearTimeout(overallTimeout); if(!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`); return r.json(); })
            .then(data => { window.__PRELOADED_PORTFOLIO_DATA = data; window.dispatchEvent(new CustomEvent('portfolio_data_ready')); pre.textContent = 'Portfolio loaded successfully'; })
            .catch(err => { clearTimeout(fetchTimeout); const is404 = err.message.includes('404') || err.message.includes('Not Found'); if (attempt < 3 && !is404) { const delay = 300 * attempt; pre.textContent = `Retrying (${attempt})...`; setTimeout(()=>fetchWithRetry(file.includes('?')? `${file}&cb=${Date.now()}` : `${file}?cb=${Date.now()}`, attempt+1), delay); } else { clearTimeout(overallTimeout); if (is404) { pre.textContent = `File not found - Redirecting to default portfolio...`; pre.style.background = '#fff4e6'; if(!(isAdminMode && isRemoteMode)){ setTimeout(() => { window.location.href = 'portfolio.html?file=portfolio-data.json'; }, 2000); } } else { pre.textContent = `Failed to load ${file.replace('data/','')}`; pre.style.background = '#ffe6e6'; const retryBtn = document.createElement('button'); retryBtn.textContent = 'Retry'; retryBtn.style.cssText='margin-left:8px;padding:4px 10px;font-size:12px;border:1px solid #c33;background:#b22222;color:#fff;border-radius:6px;cursor:pointer;'; retryBtn.onclick=()=>{ retryBtn.disabled=true; pre.textContent='Retrying...'; fetchWithRetry(file.includes('?')? `${file}&cb=${Date.now()}` : `${file}?cb=${Date.now()}`,1); }; const fallbackBtn = document.createElement('button'); fallbackBtn.textContent = 'Use Default'; fallbackBtn.style.cssText='margin-left:8px;padding:4px 10px;font-size:12px;border:1px solid #06c;background:#0066cc;color:#fff;border-radius:6px;cursor:pointer;'; fallbackBtn.onclick=()=>{ window.location.href = 'portfolio.html?file=portfolio-data.json'; }; pre.appendChild(retryBtn); pre.appendChild(fallbackBtn); } } });
        })(fileUrl,1);
        window.__ADOPT_PRELOADED = function(appInstance){ try { if(!window.__PRELOADED_PORTFOLIO_DATA) return false; if(!appInstance || typeof appInstance.normalizeLoadedData !== 'function') return false; const norm = appInstance.normalizeLoadedData(window.__PRELOADED_PORTFOLIO_DATA); appInstance.achievements = []; appInstance.reflections = []; appInstance.achievements = norm.achievements || []; appInstance.reflections = norm.reflections || []; if(norm.personalInfo){ try { if(norm.personalInfo.rollNo && !isValidRollNoFormat(norm.personalInfo.rollNo)) { norm.personalInfo.rollNo = '000-R00-X'; } localStorage.removeItem('personalInfo'); localStorage.setItem('personalInfo', JSON.stringify(norm.personalInfo)); } catch(e){} } if(norm.profilePhoto) { localStorage.removeItem('profilePhoto'); localStorage.setItem('profilePhoto', norm.profilePhoto); } else { localStorage.removeItem('profilePhoto'); } if(typeof appInstance.loadPersonalInfo === 'function') appInstance.loadPersonalInfo(); if(typeof appInstance.renderAchievements === 'function') appInstance.renderAchievements(); if(typeof appInstance.renderReflections === 'function') appInstance.renderReflections(); if(typeof appInstance.updateLinkedAchievements === 'function') appInstance.updateLinkedAchievements(); document.querySelectorAll('.section').forEach(s=>{ s.style.visibility='visible'; }); document.body.classList.remove('loading-initial'); const preEl = document.getElementById('preload-status'); if (preEl) preEl.remove(); window.__ADOPTED_SPECIFIC_PORTFOLIO = true; try { localStorage.setItem('__lastPortfolioFile', file); } catch(_){ } return true; } catch(e){ return false; } };
        const _hasSpecificFile = !!(typeof window.__CURRENT_PORTFOLIO_FILE === 'string' && window.__CURRENT_PORTFOLIO_FILE);
        let adoptionAttempts = 0;
        function tryAdoptLoop(){ if (!_hasSpecificFile) return; if (window.app && typeof window.__ADOPT_PRELOADED==='function' && window.__PRELOADED_PORTFOLIO_DATA){ const ok = window.__ADOPT_PRELOADED(window.app); if (ok) { return; } } if (adoptionAttempts < 40) { adoptionAttempts++; setTimeout(tryAdoptLoop,150); } }
        window.addEventListener('portfolio_data_ready', ()=>{ if (_hasSpecificFile) { tryAdoptLoop(); } });
        window.addEventListener('pageshow', function(e){ if(!file) return; let stored = null; try { stored = localStorage.getItem('__lastPortfolioFile'); } catch(_){ } const mismatch = (stored && stored !== file); if (e.persisted || mismatch) { const refetchUrl = file.includes('?') ? `${file}&bf=${Date.now()}` : `${file}?bf=${Date.now()}`; fetch(refetchUrl, { cache:'no-store', headers:{'Cache-Control':'no-cache, no-store, must-revalidate','Pragma':'no-cache','Expires':'0'} }) .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }) .then(data => { window.__PRELOADED_PORTFOLIO_DATA = data; if (window.app && typeof window.__ADOPT_PRELOADED === 'function') { window.__ADOPT_PRELOADED(window.app); } }) .catch(err=>console.warn('[portfolio-loader] BFCache refetch failed', err)); } });
    })();
    </script>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="nav-brand">
                <h1>Rawalpindi Medical University</h1>
                <p>Abdul Haseeb Ahmad</p>
                <!-- Build/version stamp to help confirm deployed changes -->
                <div id="build-version" style="font-size:12px;color:var(--muted-foreground);margin-top:4px;">v2025.09.25-1</div>
            </div>
            <nav class="nav-menu">
                <button class="nav-item active" data-section="personal">Personal Info</button>
                <button class="nav-item" data-section="descriptive">Descriptive Portfolio</button>
                <button class="nav-item" data-section="reflective">Reflective Portfolio</button>
                <button id="export-pdf" class="nav-item" title="Export visible portfolio to PDF">Export to PDF</button>
                <button id="save-to-server" class="nav-item rmu-save-btn" title="Save portfolio to server" style="display:none;">
                    💾 Save to Server
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div id="initial-status" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);font:600 16px Inter,system-ui,sans-serif;color:#444;background:#fff;padding:18px 26px;border:1px solid #d0d7df;border-radius:14px;box-shadow:0 6px 28px -10px rgba(0,0,0,.15);z-index:9998;display:none;">
            Loading portfolio data...
        </div>
        <!-- Personal Information Section -->
        <section id="personal" class="section active">
            <div class="container">
                <div class="rmu-portfolio-container">
                    <!-- Modern 3-Column Layout -->
                    <div class="rmu-modern-layout">
                        <!-- Edit Controls -->
                        <div class="rmu-edit-controls">
                            <button class="rmu-edit-button" id="edit-personal">Edit</button>
                            <button id="save-personal" class="rmu-save-button" style="display:none;">Save</button>
                            <button id="cancel-personal" class="rmu-cancel-button" style="display:none;">Cancel</button>
                        </div>
                        
                        <!-- Main Content Area (Left 2 Columns) -->
                        <div class="rmu-content-area">
                            <!-- Header Section with Logo and Title -->
                            <div class="rmu-header-modern">
                                <div class="rmu-logo-section">
                                    <img src="RMUlogo.png" alt="RMU Logo" class="rmu-logo-modern">
                                    <div class="rmu-title-modern">
                                        <div class="rmu-editable-field rmu-portfolio-title" data-field="title">
                                            <span id="title-display">Abdul Haseeb's Medfolio</span>
                                            <input type="text" id="title" value="Abdul Haseeb's Medfolio" style="display:none;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Personal Information Fields (2 Columns) -->
                            <div class="rmu-fields-container">
                                <!-- Left Column -->
                                <div class="rmu-field-column">
                                    <div class="rmu-field">
                                        <label class="rmu-field-label">Student Name</label>
                                        <div class="rmu-editable-field rmu-student-name" data-field="studentName">
                                            <span id="firstName-display">Abdul Haseeb Ahmad</span>
                                            <input type="text" id="firstName" value="Abdul Haseeb Ahmad" style="display:none;">
                                        </div>
                                    </div>

                                    <div class="rmu-field">
                                        <label class="rmu-field-label">Roll No</label>
                                        <div class="rmu-editable-field rmu-detail-text" data-field="rollNo">
                                            <span id="rollNo-display">123</span>
                                            <input type="text" id="rollNo" value="123" style="display:none;">
                                        </div>
                                    </div>

                                    <div class="rmu-field">
                                        <label class="rmu-field-label">Registration No</label>
                                        <div class="rmu-editable-field rmu-small-detail-text" data-field="registrationNo">
                                            <span id="registrationNo-display">RMU-MBBS-2024-001</span>
                                            <input type="text" id="registrationNo" value="RMU-MBBS-2024-001" style="display:none;">
                                        </div>
                                    </div>

                                    <div class="rmu-field">
                                        <label class="rmu-field-label">Program Enrolled</label>
                                        <div class="rmu-editable-field rmu-small-detail-text" data-field="programEnrolled">
                                            <span id="programEnrolled-display">MBBS</span>
                                            <input type="text" id="programEnrolled" value="MBBS" style="display:none;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column -->
                                <div class="rmu-field-column">
                                    <div class="rmu-field">
                                        <label class="rmu-field-label">Father's Name</label>
                                        <div class="rmu-editable-field rmu-student-name" data-field="fatherName">
                                            <span id="fatherName-display">Muhammad Athar</span>
                                            <input type="text" id="fatherName" value="Muhammad Athar" style="display:none;">
                                        </div>
                                    </div>

                                    <div class="rmu-field">
                                        <label class="rmu-field-label">Email</label>
                                        <div class="rmu-editable-field rmu-small-detail-text" data-field="email">
                                            <span id="email-display">abdul.haseeb@student.rmu.edu.pk</span>
                                            <input type="email" id="email" value="abdul.haseeb@student.rmu.edu.pk" style="display:none;">
                                        </div>
                                    </div>

                                    <div class="rmu-field">
                                        <label class="rmu-field-label">Mobile No</label>
                                        <div class="rmu-editable-field rmu-small-detail-text" data-field="mobileNo">
                                            <span id="phone-display">+92 300 1234567</span>
                                            <input type="tel" id="phone" value="+92 300 1234567" style="display:none;">
                                        </div>
                                    </div>
                                    
                                    <div class="rmu-field">
                                        <label class="rmu-field-label">Session</label>
                                        <div class="rmu-editable-field rmu-small-detail-text" data-field="session">
                                            <span id="session-display">2024-25</span>
                                            <input type="text" id="session" value="2024-25" style="display:none;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Professional Bio Section (Full Width) -->
                            <div class="rmu-bio-section-modern">
                                <h3 class="rmu-bio-title">Professional Bio</h3>
                                <div class="rmu-editable-field rmu-bio-content" data-field="professionalBio">
                                    <span id="bio-display">Passionate medical student dedicated 1. To impart evidence based research oriented medical education. 2. To provide best possible patient care. 3. To inculcate the values of mutual respect and ethical practice of medicine.</span>
                                    <textarea id="bio" rows="4" style="display:none;">Passionate medical student dedicated 1. To impart evidence based research oriented medical education. 2. To provide best possible patient care. 3. To inculcate the values of mutual respect and ethical practice of medicine.</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Picture Column (Right) -->
                        <div class="rmu-profile-column">
                            <div class="rmu-profile-picture-modern">
                                <img src="profile.png" alt="Profile" class="rmu-profile-img-modern">
                                <input type="file" id="profile-photo-input" accept="image/*" style="display:none;" />
                                <button id="change-photo" class="rmu-change-photo-btn-modern" style="display:none;">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                        <circle cx="12" cy="13" r="4"/>
                                    </svg>
                                    Change Photo
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="rmu-footer"></div>
                </div>
            </div>
        </section>

        <!-- Descriptive Portfolio Section -->
        <section id="descriptive" class="section">
            <div class="container">
                <div class="section-header">
                    <div>
                        <h2>Descriptive Portfolio</h2>
                        <p>Academic achievements, clinical experiences, and professional development</p>
                    </div>
                    <div class="section-actions">
                        <div class="search-container">
                            <input type="text" id="search-descriptive" placeholder="Search achievements..." class="search-input">
                            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <circle cx="11" cy="11" r="8"/>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                        </div>
                        <!-- Category bar: full-width pill bar with dividers. On mobile, show a compact UI: one 'All' pill + a dropdown to pick other categories -->
                        <div id="descriptive-categories" class="category-bar-wrapper">
                            <button class="descriptive-category active" data-category="" aria-pressed="true">
                                <svg class="category-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
                                <span>All</span>
                            </button>
                            <button class="descriptive-category" data-category="academic">
                                <svg class="category-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M12 2l9 4-9 4-9-4 9-4z"/><path d="M3 10v4a9 9 0 0 0 18 0v-4"/></svg>
                                <span>Academics</span>
                            </button>
                            <button class="descriptive-category" data-category="clinical">
                                <svg class="category-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M20 8v6a6 6 0 0 1-12 0V8"/><path d="M16 6a4 4 0 1 0-8 0v2"/><path d="M12 14v6"/></svg>
                                <span>Clinical</span>
                            </button>
                            <button class="descriptive-category" data-category="extracurricular">
                                <svg class="category-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M17 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                <span>Extracurricular</span>
                            </button>
                            <button class="descriptive-category" data-category="research">
                                <svg class="category-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M6 3h12l-2 7a6 6 0 0 1-8 0L6 3z"/><path d="M8 14h8"/></svg>
                                <span>Research</span>
                            </button>
                            <!-- Mobile-only select: hidden on desktop, visible on small screens -->
                            <select id="mobile-descriptive-select" class="mobile-descriptive-select" aria-label="Choose category (mobile)">
                                <option value="">All</option>
                                <option value="academic">Academics</option>
                                <option value="clinical">Clinical</option>
                                <option value="extracurricular">Extracurricular</option>
                                <option value="research">Research</option>
                            </select>
                        </div>
                        <button id="add-achievement" class="btn btn-primary">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add Achievement
                        </button>
                    </div>
                </div>

                <div class="achievements-grid" id="achievements-container">
                    <!-- Achievements will be populated by JavaScript -->
                </div>
                <!-- Category summary cards (4 equal rectangles) -->
                <div id="category-cards" class="category-cards" aria-hidden="false">
                    <div class="cat-card" data-key="academic">
                        <div class="cat-icon" aria-hidden="true">
                            <!-- nicer school / graduation cap icon -->
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L1 7l11 5 9-4.09V17a2 2 0 0 1-2 2h-2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 22v-9" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <div class="cat-count">0</div>
                        <div class="cat-label">Academics</div>
                    </div>
                    <div class="cat-card" data-key="clinical">
                        <div class="cat-icon" aria-hidden="true">
                            <!-- nicer stethoscope icon -->
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20 8v6a6 6 0 0 1-12 0V8" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 8V5a2 2 0 0 1 2-2h6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <div class="cat-count">0</div>
                        <div class="cat-label">Clinical</div>
                    </div>
                    <div class="cat-card" data-key="extracurricular">
                        <div class="cat-icon" aria-hidden="true">
                            <!-- people / activities icon -->
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M17 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="7" r="4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <div class="cat-count">0</div>
                        <div class="cat-label">Extracurricular</div>
                    </div>
                    <div class="cat-card" data-key="research">
                        <div class="cat-icon" aria-hidden="true">
                            <!-- microscope / research icon -->
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M6 3h12l-2 7a6 6 0 0 1-8 0L6 3z" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 14h6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <div class="cat-count">0</div>
                        <div class="cat-label">Research</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reflective Portfolio Section -->
        <section id="reflective" class="section">
            <div class="container">
                <div class="section-header">
                    <div>
                        <h2>Reflective Portfolio</h2>
                        <p>Personal reflections, learning experiences, and professional growth</p>
                    </div>
                    <div class="section-actions">
                        <div class="search-container">
                            <input type="text" id="search-reflective" placeholder="Search reflections..." class="search-input">
                            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <circle cx="11" cy="11" r="8"/>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                        </div>
                        <select id="filter-reflective" class="filter-select">
                            <option value="">All Moods</option>
                            <option value="positive">Positive</option>
                            <option value="challenging">Challenging</option>
                            <option value="neutral">Neutral</option>
                        </select>
                        <button id="add-reflection" class="btn btn-primary">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add Reflection
                        </button>
                    </div>
                </div>

                <div class="reflections-container" id="reflections-container">
                    <!-- Reflections will be populated by JavaScript -->
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div id="achievement-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="achievement-modal-title">Add Achievement</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="achievement-form">
                    <div class="form-group">
                        <label for="achievement-title">Title</label>
                        <input type="text" id="achievement-title" required>
                    </div>
                    <div class="form-group">
                        <label for="achievement-category">Category</label>
                            <select id="achievement-category" required>
                            <option value="">Select Category</option>
                            <option value="academic">Academics</option>
                            <option value="clinical">Clinical</option>
                            <option value="extracurricular">Extracurricular</option>
                            <option value="research">Research</option>
                            <option value="certification">Certification</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="achievement-date">Date</label>
                        <input type="date" id="achievement-date" required>
                    </div>
                    <div class="form-group">
                        <label for="achievement-description">Description</label>
                        <textarea id="achievement-description" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="achievement-image">Images (optional, you may select multiple)</label>
                        <input type="file" id="achievement-image" accept="image/*" multiple>
                    </div>
                    <div class="form-group">
                        <label for="achievement-ppt">PowerPoint (PPT, optional)</label>
                        <input type="file" id="achievement-ppt" accept=".ppt,.pptx,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation">
                    </div>
                    <div class="form-group">
                        <label for="achievement-pdf">PDF (optional)</label>
                        <input type="file" id="achievement-pdf" accept="application/pdf">
                    </div>
                    <div class="form-group">
                        <label for="achievement-status">Status</label>
                        <select id="achievement-status" required>
                            <option value="completed">Completed</option>
                            <option value="in-progress">In Progress</option>
                            <option value="planned">Planned</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline modal-cancel">Cancel</button>
                <button type="submit" form="achievement-form" class="btn btn-primary">Save Achievement</button>
            </div>
        </div>
    </div>

    <div id="reflection-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reflection-modal-title">Add Reflection</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reflection-form">
                    <div class="form-group">
                        <label for="reflection-title">Title</label>
                        <input type="text" id="reflection-title" required>
                    </div>
                    <div class="form-group">
                        <label for="reflection-date">Date</label>
                        <input type="date" id="reflection-date" required>
                    </div>
                    <div class="form-group">
                        <label for="reflection-mood">Mood</label>
                        <select id="reflection-mood" required>
                            <option value="">Select Mood</option>
                            <option value="positive">Positive</option>
                            <option value="challenging">Challenging</option>
                            <option value="neutral">Neutral</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reflection-content">Reflection Content</label>
                        <textarea id="reflection-content" rows="8" placeholder="Write your thoughts and reflections..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="reflection-image">Images (optional, you may select multiple)</label>
                        <input type="file" id="reflection-image" accept="image/*" multiple>
                    </div>
                    <div class="form-group">
                        <label for="reflection-ppt">PowerPoint (PPT, optional)</label>
                        <input type="file" id="reflection-ppt" accept=".ppt,.pptx,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation">
                    </div>
                    <div class="form-group">
                        <label for="reflection-pdf">PDF (optional)</label>
                        <input type="file" id="reflection-pdf" accept="application/pdf">
                    </div>
                    <div class="form-group">
                        <label for="reflection-linked">Link to Achievement</label>
                        <select id="reflection-linked">
                            <option value="">No linked achievement</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline modal-cancel">Cancel</button>
                <button type="submit" form="reflection-form" class="btn btn-primary">Save Reflection</button>
            </div>
        </div>
    </div>

    <!-- html2canvas and jsPDF for client-side export to PDF (load libraries first) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="portfolio.js?v=20250925.3"></script>
    <script>
    (function(){
        async function tryAdopt() {
            if(window.app && typeof window.__ADOPT_PRELOADED === 'function'){
                console.log('[portfolio-loader] App ready, attempting adoption...');
                const success = window.__ADOPT_PRELOADED(window.app);
                if(success) {
                    console.log('[portfolio-loader] ✓ Data adoption successful');
                } else {
                    console.log('[portfolio-loader] ⚠ Data adoption failed or no data to adopt');
                }
                
                // Check if we should auto-load from Drive for user mode
                if (window.__AUTO_LOAD_FROM_DRIVE && window.app && typeof window.app.loadFromDrive === 'function') {
                    console.log('[portfolio-loader] Auto-loading user portfolio from Drive...');
                    try {
                        await window.app.loadFromDrive();
                        console.log('[portfolio-loader] ✓ Auto-load from Drive successful');
                    } catch(e) {
                        console.log('[portfolio-loader] ⚠ Auto-load from Drive failed:', e.message);
                    }
                    window.__AUTO_LOAD_FROM_DRIVE = false; // Prevent duplicate attempts
                }
                return; // Exit after processing
            } else {
                // Limit retry attempts to prevent infinite loop
                if (!window.__ADOPT_RETRY_COUNT) window.__ADOPT_RETRY_COUNT = 0;
                window.__ADOPT_RETRY_COUNT++;
                
                if (window.__ADOPT_RETRY_COUNT > 200) { // Max 20 seconds of retries
                    console.warn('[portfolio-loader] ⚠ Max retry attempts reached, stopping...');
                    return;
                }
                
                console.log(`[portfolio-loader] App or adoption function not ready yet, retrying... (${window.__ADOPT_RETRY_COUNT}/200)`);
                setTimeout(tryAdopt, 100); // retry in 100ms
            }
        }
        
        // Try immediately, then retry if needed
        setTimeout(tryAdopt, 50);
    })();
    </script>
    <script>
        (async function(){
            try{
                const cssLinks = Array.from(document.querySelectorAll('link[rel="stylesheet"]')).map(l=>l.href);
                const scriptSrcs = Array.from(document.querySelectorAll('script[src]')).map(s=>s.src);
                const stamp = document.getElementById('build-version');
                const portfolioCssHref = cssLinks.find(h=>h && h.includes('portfolio.css')) || null;
                const portfolioJsHref = scriptSrcs.find(s=>s && s.includes('portfolio.js')) || null;
                if (stamp) {
                    const cssStatus = portfolioCssHref ? 'OK' : 'MISSING';
                    const jsStatus = portfolioJsHref ? 'OK' : 'MISSING';
                    stamp.textContent = `${stamp.textContent} | CSS: ${cssStatus} | JS: ${jsStatus}`;
                }
                if (stamp) { stamp.textContent += ' | mode: external-json-only'; }
            } catch (e) {}
        })();
    </script>
<div id="auth-status" style="position:fixed;top:10px;right:180px;z-index:9999;background:#fff;padding:6px;border:1px solid #ccc;border-radius:6px;display:none;font-size:13px;"></div>
<div id="global-loading-bar"><div class="glb-progress"></div></div>
<button id="authorize_button" style="display:block;position:fixed;top:10px;right:10px;z-index:9999;padding: 5px;">Sign in with Google</button>
<button id="signout_button" style="display:none;position:fixed;top:40px;right:10px;z-index:9999;">Sign out</button>
<button id="save-drive" onclick="app.saveToDrive()" style="display:none;position:fixed;top:70px;right:10px;z-index:9999;">Save to Drive</button>
<button id="load-drive" onclick="app.loadFromDrive()" style="display:none;position:fixed;top:100px;right:10px;z-index:9999;">Load from Drive</button>
<button id="export-json" onclick="app.exportPortfolioJson()" style="display:none;position:fixed;top:130px;right:10px;z-index:9999;">Export JSON</button>
<button id="import-json" onclick="document.getElementById('import-json-input').click()" style="display:none;position:fixed;top:160px;right:10px;z-index:9999;">Import JSON</button>
<input type="file" id="import-json-input" accept="application/json" style="display:none" />
<button id="drive-selftest" onclick="app.runDriveSelfTest()" style="display:none;position:fixed;top:190px;right:10px;z-index:9999;">Test Drive Sync</button>
<script>
const CLIENT_ID = (window.RMU_CONFIG && window.RMU_CONFIG.GOOGLE_CLIENT_ID) || window.GOOGLE_CLIENT_ID || 'YOUR_OAUTH_CLIENT_ID.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
let tokenClient; let accessToken = null;
async function initializeGisAndGapi() {
    await new Promise(resolve => { if (window.gapi && gapi.client) return resolve(); gapi.load('client', async () => { try { await gapi.client.init({ discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] }); } catch(e){} resolve(); }); });
    tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: async (tokenResponse) => { if (tokenResponse && tokenResponse.access_token) { accessToken = tokenResponse.access_token; try { gapi.client.setToken({ access_token: accessToken }); } catch(_){} if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', () => updateAuthUIStateGIS(true)); } else { updateAuthUIStateGIS(true); } try { const isUserMode = sessionStorage.getItem('isUserMode') === 'true'; if (isUserMode && window.app && typeof window.app.loadFromDrive === 'function') { setTimeout(() => window.app.loadFromDrive(), 100); } } catch(e){} } }});
    try { const isUserMode = sessionStorage.getItem('isUserMode') === 'true'; const userEmail = sessionStorage.getItem('userEmail'); const ssToken = sessionStorage.getItem('userToken'); if (isUserMode && userEmail && ssToken) { try { gapi.client.setToken({ access_token: ssToken }); accessToken = ssToken; if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', () => { updateAuthUIStateGIS(true); if (window.app && typeof window.app.loadFromDrive === 'function') { setTimeout(() => window.app.loadFromDrive(), 500); } }); } else { updateAuthUIStateGIS(true); if (window.app && typeof window.app.loadFromDrive === 'function') { setTimeout(() => window.app.loadFromDrive(), 500); } } } catch (e) {} tokenClient.requestAccessToken({ prompt: '' }); } } catch (e) {}
    document.getElementById('authorize_button').addEventListener('click', () => { if (!tokenClient) return; tokenClient.requestAccessToken({ prompt: 'consent' }); });
    document.getElementById('signout_button').addEventListener('click', () => { try { if (accessToken) { fetch('https://oauth2.googleapis.com/revoke?token=' + accessToken, { method: 'POST', headers: {'Content-type': 'application/x-www-form-urlencoded'} }).catch(()=>{}); accessToken = null; } if (typeof gapi !== 'undefined' && gapi.client) { gapi.client.setToken({}); } try { sessionStorage.clear(); localStorage.removeItem('userToken'); localStorage.removeItem('userEmail'); localStorage.removeItem('personalInfo'); localStorage.removeItem('profilePhoto'); } catch(_) {} if (window.RMU_AUTH && typeof RMU_AUTH.signOut === 'function') { RMU_AUTH.signOut().catch(()=>{}); } if (window.google && google.accounts && google.accounts.id) { try { google.accounts.id.disableAutoSelect(); } catch(_) {} } updateAuthUIStateGIS(false); setTimeout(() => { window.location.href = 'index.html'; }, 200); } catch(_) { setTimeout(() => { window.location.href = 'index.html'; }, 300); } });
    const poll = setInterval(()=>{ try{ const token = gapi.client.getToken && gapi.client.getToken(); if (token && token.access_token) { accessToken = token.access_token; updateAuthUIStateGIS(true); clearInterval(poll); } }catch(e){} }, 700);
}
function updateAuthUIStateGIS(signedIn) { const statusDiv = document.getElementById('auth-status'); const authBtn = document.getElementById('authorize_button'); const signOutBtn = document.getElementById('signout_button'); const saveBtn = document.getElementById('save-drive'); const loadBtn = document.getElementById('load-drive'); const exportBtn = document.getElementById('export-json'); const importBtn = document.getElementById('import-json'); const importInput = document.getElementById('import-json-input'); const selftestBtn = document.getElementById('drive-selftest'); if (signedIn) { if (statusDiv) { statusDiv.innerText = 'Signed in (Drive access granted)'; statusDiv.style.display = 'block'; } if (authBtn) { authBtn.style.display = 'none'; } if (signOutBtn) { signOutBtn.style.display = 'inline-block'; } if (saveBtn) { saveBtn.style.setProperty('display','inline-block','important'); } if (loadBtn) { loadBtn.style.setProperty('display','inline-block','important'); } if (exportBtn) { exportBtn.style.setProperty('display','inline-block','important'); } if (importBtn) { importBtn.style.setProperty('display','inline-block','important'); } if (selftestBtn) { selftestBtn.style.setProperty('display','inline-block','important'); } if (importInput && !importInput._bound) { importInput.addEventListener('change', (e)=>{ const file = e.target.files && e.target.files[0]; if (file && window.app && typeof window.app.handleImportJsonFile === 'function') { window.app.handleImportJsonFile(file); e.target.value = ''; } }); importInput._bound = true; } } else { if (statusDiv) { statusDiv.style.display = 'none'; } if (authBtn) { authBtn.style.display = 'block'; } if (signOutBtn) { signOutBtn.style.display = 'none'; } if (saveBtn) { saveBtn.style.setProperty('display','none','important'); } if (loadBtn) { loadBtn.style.setProperty('display','none','important'); } if (exportBtn) { exportBtn.style.setProperty('display','none','important'); } if (importBtn) { importBtn.style.setProperty('display','none','important'); } if (selftestBtn) { selftestBtn.style.setProperty('display','none','important'); } } }
window.addEventListener('load', () => { const check = setInterval(()=>{ if (window.google && window.gapi) { clearInterval(check); initializeGisAndGapi(); } }, 300); });
</script>

<!-- Authentication Modal Overlays -->
<style>
    .auth-overlay{position:fixed;inset:0;background:rgba(10,20,40,.55);backdrop-filter:saturate(1.1) blur(3px);display:none;align-items:center;justify-content:center;z-index:10000}
    .auth-modal{width:min(520px,92vw);background:#fff;border-radius:16px;border:1px solid #d8e0ea;box-shadow:0 24px 64px -16px rgba(16,40,80,.35);padding:22px}
    .auth-title{font:600 18px Inter,system-ui,sans-serif;color:#0b2340;margin:4px 0 12px}
    .auth-desc{font:13px/1.45 Inter,system-ui,sans-serif;color:#3a4b61;margin-bottom:16px}
    .auth-actions{display:flex;gap:10px;justify-content:flex-end}
    .auth-btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font:600 13px Inter,system-ui,sans-serif;cursor:pointer}
    .auth-btn-primary{background:linear-gradient(90deg,#0a66c2,#2b79ff);color:#fff;box-shadow:0 8px 20px -8px rgba(10,70,150,.45)}
    .auth-btn-ghost{background:#f3f6fb;color:#0b2340}
    .auth-error{color:#b22222;background:#fff2f2;border:1px solid #f0c8c8;border-radius:10px;padding:8px 10px;font:12px Inter,system-ui,sans-serif;display:none;margin-bottom:10px}
    .rmu-save-btn{background:linear-gradient(135deg,#6e1c17 0%,#55120f 100%) !important;color:#fff !important;border:2px solid #55120f !important;box-shadow:0 4px 12px -4px rgba(110,28,23,.4) !important;transition:all 0.3s ease !important}
    .rmu-save-btn:hover{transform:translateY(-1px) !important;box-shadow:0 6px 16px -4px rgba(110,28,23,.5) !important;background:linear-gradient(135deg,#55120f 0%,#6e1c17 100%) !important}
    #save-to-server{display:inline-flex;align-items:center;gap:6px}
    body.signed-in #save-to-server{display:inline-flex !important}
    /* nav-signout removed */
</style>

<!-- Student Sign-In Modal -->
<div id="auth-overlay" class="auth-overlay" role="dialog" aria-modal="true" aria-labelledby="auth-title">
    <div class="auth-modal">
        <div class="auth-title" id="auth-title">Sign in to save portfolio</div>
        <div id="auth-error" class="auth-error" style="display:none"></div>
        <div class="auth-desc">Sign in with your Google account to save your portfolio data to the server. Your data will be securely stored and accessible across devices.</div>
        <div class="auth-actions">
            <button id="auth-cancel" class="auth-btn auth-btn-ghost">Cancel</button>
            <button id="auth-signin" class="auth-btn auth-btn-primary">Sign in with Google</button>
        </div>
    </div>
</div>

<!-- Save to Server Modal -->
<div id="save-server-modal" class="auth-overlay" role="dialog" aria-modal="true" style="display:none">
    <div class="auth-modal">
        <div class="auth-title">Saving to Server</div>
        <div id="save-server-status" class="auth-desc">Preparing to save...</div>
        <div class="auth-actions">
            <button id="save-server-cancel" class="auth-btn auth-btn-ghost" style="display:none">Close</button>
        </div>
    </div>
</div>

<script>
(function(){
    const saveBtn = document.getElementById('save-to-server');
    const authOverlay = document.getElementById('auth-overlay');
    const authError = document.getElementById('auth-error');
    const saveModal = document.getElementById('save-server-modal');
    const saveStatus = document.getElementById('save-server-status');
    const saveCancel = document.getElementById('save-server-cancel');
    
    function showAuthOverlay(show) {
        if(authOverlay) authOverlay.style.display = show ? 'flex' : 'none';
    }
    
    function showSaveModal(show, msg) {
        if(saveModal) saveModal.style.display = show ? 'flex' : 'none';
        if(saveStatus && msg) saveStatus.textContent = msg;
    }
    
    function setAuthError(msg) {
        if(authError) {
            authError.textContent = msg || '';
            authError.style.display = msg ? 'block' : 'none';
        }
    }
    
    async function signInAndSave() {
        try {
            showAuthOverlay(false);
            showSaveModal(true, 'Signing in...');
            
            let signedIn = false;
            // Prefer RMU_AUTH (GIS) for token and email
            if (window.RMU_AUTH && typeof RMU_AUTH.authenticateUser === 'function') {
                try {
                    const res = await RMU_AUTH.authenticateUser();
                    if (res && res.token) {
                        window.__USER_TOKEN = res.token;
                        if (res.email) window.__USER_EMAIL = res.email;
                        document.body.classList.add('signed-in');
                        signedIn = true;
                    }
                } catch(e) {
                    console.warn('[Save] RMU_AUTH auth failed, will try gapi if available', e);
                }
            }
            
            if (!signedIn) {
                // Fallback to gapi.auth2 if present
                if (typeof gapi === 'undefined') {
                    throw new Error('Google API not loaded. Please refresh and try again.');
                }
                await new Promise(resolve => gapi.load('auth2', resolve));
                let authInstance = gapi.auth2.getAuthInstance();
                if(!authInstance) {
                    const config = window.RMU_CONFIG || {};
                    authInstance = await gapi.auth2.init({
                        client_id: config.GOOGLE_CLIENT_ID || window.GOOGLE_CLIENT_ID,
                        scope: config.OAUTH_SCOPES || 'profile email openid'
                    });
                }
                await authInstance.signIn();
                document.body.classList.add('signed-in');
            }
            await performSave();
            
        } catch(err) {
            console.error('Sign-in error:', err);
            showSaveModal(false);
            setAuthError('Sign-in failed: ' + (err.message || err));
            showAuthOverlay(true);
        }
    }
    
    async function getDriveAccessTokenPreferred(options = {}) {
        const interactive = !!options.interactive;
        try {
            // If gapi client already holds a token, use it
            if (window.gapi && gapi.client && typeof gapi.client.getToken === 'function') {
                const t = gapi.client.getToken();
                if (t && t.access_token) return t.access_token;
            }
            // If a token client exists, request a token (silent first, then interactive when requested)
            if (window.tokenClient) {
                return await new Promise((resolve) => {
                    const originalCb = window.tokenClient.callback;
                    window.tokenClient.callback = (resp) => {
                        try {
                            if (resp && resp.access_token) {
                                // gapi.client.setToken will be called by existing init code; return the token
                                resolve(resp.access_token);
                            } else {
                                resolve(null);
                            }
                        } finally {
                            // Restore original callback to avoid side effects
                            window.tokenClient.callback = originalCb;
                        }
                    };
                    window.tokenClient.requestAccessToken({ prompt: interactive ? 'consent' : '' });
                });
            }
        } catch(_) { /* fall through */ }
        return null;
    }

    async function performSave() {
        try {
            const cfg = window.RMU_CONFIG || {};
            const base = (cfg.BACKEND_BASE || '').replace(/\/$/, '');

            if (!base) throw new Error('Backend not configured. Please check config.js');
            if (!window.app) throw new Error('Portfolio not initialized');

            showSaveModal(true, 'Preparing portfolio data...');

            // Helpers
            const isValidEmail = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||'').trim());
            const sanitizeFilename = (s) => {
                const cleaned = String(s||'').normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Za-z0-9\-_. ]/g,'-').replace(/\s+/g,'-').replace(/-+/g,'-').replace(/^[-.]+|[-.]+$/g,'');
                return cleaned.slice(0, 80) || 'portfolio';
            };

            // Gather personal info and compute email robustly
            const personal = (() => { try { return JSON.parse(localStorage.getItem('personalInfo')||'{}'); } catch(_) { return {}; } })();
            const emailCandidates = [
                personal.email,
                window.RMU_AUTH?.getCurrentUserEmail?.(),
                window.__USER_EMAIL,
                (()=>{ try { return sessionStorage.getItem('userEmail'); } catch(_) { return null; } })()
            ].filter(Boolean);
            const email = (emailCandidates.find(isValidEmail) || '').toLowerCase();
            if (!email) {
                throw new Error('No valid email found. Please sign in and ensure your email is set in Personal Info.');
            }

            // Roll number for metadata/filename
            const roll = personal.rollNo || personal.roll || '';

            // Derive a stable filename
            const studentName = personal.studentName || personal.fullName || [personal.firstName, personal.lastName].filter(Boolean).join(' ') || '';
            const rollNo = roll || '';
            let filename;
            if (studentName && rollNo) filename = `${studentName}-${rollNo}`; else if (studentName) filename = `${studentName}-portfolio`; else filename = `user-${email.split('@')[0]}`;
            filename = sanitizeFilename(filename.toLowerCase());

            // Normalize portfolio payload shape expected by backend
            const achievements = Array.isArray(app.achievements) ? app.achievements : [];
            const reflections = Array.isArray(app.reflections) ? app.reflections : [];
            // Ensure personal includes the chosen email
            if (!personal.email || personal.email.toLowerCase() !== email) {
                personal.email = email;
                try { localStorage.setItem('personalInfo', JSON.stringify(personal)); } catch(_) {}
            }
            const portfolioPayload = {
                achievements,
                reflections,
                personalInfo: personal && typeof personal === 'object' ? personal : {},
                profilePhoto: localStorage.getItem('profilePhoto') || null
            };

            // Final payload
            const payload = { roll, email, filename, portfolio: portfolioPayload };

            showSaveModal(true, 'Obtaining credentials...');

            // Get backend auth token:
            // Avoid One Tap ID token flow (can cause 400 error in some contexts). Prefer GIS token client (access token),
            // then fall back to any cached/session token, then gapi.auth2.
            let accessToken = null;
            let idToken = null;

            if (window.RMU_AUTH && typeof RMU_AUTH.authenticateUser === 'function') {
                try {
                    const res = await RMU_AUTH.authenticateUser();
                    accessToken = res?.token || null;
                    if (res?.email) { window.__USER_EMAIL = res.email; }
                } catch(_) { /* will try fallbacks below */ }
            }

            if (!accessToken) {
                try { accessToken = sessionStorage.getItem('userToken'); } catch(_) {}
            }
            if (!accessToken && window.__USER_TOKEN) {
                accessToken = window.__USER_TOKEN;
            }
            if (!accessToken && typeof gapi !== 'undefined' && gapi.auth2 && gapi.auth2.getAuthInstance) {
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance) {
                    const user = authInstance.currentUser.get();
                    if (user && user.isSignedIn()) {
                        const authResponse = user.getAuthResponse();
                        accessToken = authResponse?.access_token || null;
                        idToken = authResponse?.id_token || authResponse?.idToken || null;
                    }
                }
            }
            const authToken = accessToken || idToken;
            if (!authToken) throw new Error('Unable to obtain authentication token. Please sign in again.');

            showSaveModal(true, 'Saving to server...');

            const response = await fetch(base + '/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                body: JSON.stringify({
                    ...payload,
                    metadata: {
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString(),
                        source: 'portfolio-website',
                        version: '1.0'
                    }
                }),
                credentials: 'omit',
                cache: 'no-store'
            });

            if (!response.ok) {
                const errorText = await response.text().catch(() => response.statusText);
                // Common backend validations mapped to friendlier messages
                if (/Invalid\s+email/i.test(errorText)) throw new Error('Your email looks invalid. Please update it in Personal Info or sign in again.');
                if (/Invalid\s+portfolio/i.test(errorText)) throw new Error('Your portfolio data is not in the expected format. Try making a small edit and saving again.');
                if (/(storage\s+quota|quota\s+exceeded|insufficient\s+storage|temporarily\s+full|storage\s+full|out\s+of\s+space)/i.test(errorText)) {
                    throw new Error('Storage temporarily unavailable on the server. Please try again later or contact the administrator.');
                }
                if (/(Access\s+denied|Forbidden|permissions|unauthorized|unauthorised|invalid token|invalid signature)/i.test(errorText)) throw new Error('Access denied. Make sure you are using the same account you signed in with.');
                throw new Error('Server error: ' + errorText);
            }

            const result = await response.json().catch(() => ({ success: false }));
            if (result && result.success) {
                showSaveModal(true, 'Portfolio saved successfully!' + (result.fileId ? ` (ID: ${result.fileId})` : ''));
                saveCancel.style.display = 'inline-block';
                saveCancel.onclick = () => showSaveModal(false);
            } else {
                throw new Error(result?.error || 'Unknown server error');
            }

        } catch (err) {
            console.error('Save error:', err);
            showSaveModal(true, 'Save failed: ' + (err.message || err));
            saveCancel.style.display = 'inline-block';
            saveCancel.onclick = () => showSaveModal(false);
        }
    }
    
    // Event handlers
    if(saveBtn) {
        saveBtn.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Check if already signed in
            const isSignedIn = document.body.classList.contains('signed-in') ||
                             (window.RMU_AUTH && RMU_AUTH.getCurrentUserEmail()) ||
                             (typeof gapi !== 'undefined' && gapi.auth2 && gapi.auth2.getAuthInstance && gapi.auth2.getAuthInstance()?.isSignedIn?.get());
            
            if(isSignedIn) {
                performSave();
            } else {
                showAuthOverlay(true);
                setAuthError('');
            }
        });
    }
    
    document.getElementById('auth-signin')?.addEventListener('click', signInAndSave);
    document.getElementById('auth-cancel')?.addEventListener('click', () => showAuthOverlay(false));
    
    // Show save button when signed in
    function checkSignInStatus() {
        let isSignedIn = false;
        // Check session user mode
        try { isSignedIn = isSignedIn || (sessionStorage.getItem('isUserMode') === 'true' && !!sessionStorage.getItem('userEmail')); } catch(_) {}
        // Check RMU_AUTH
        if(!isSignedIn && window.RMU_AUTH && RMU_AUTH.getCurrentUserEmail()) {
            isSignedIn = true;
        }
        // Check gapi.auth2
        if(!isSignedIn && typeof gapi !== 'undefined' && gapi.auth2 && gapi.auth2.getAuthInstance()) {
            const authInstance = gapi.auth2.getAuthInstance();
            isSignedIn = authInstance.isSignedIn.get();
        }
        document.body.classList.toggle('signed-in', !!isSignedIn);
    }
    
    // Check initial sign-in status
    checkSignInStatus();
    
    // Check periodically for auth state changes
    setInterval(checkSignInStatus, 1000);
    
    // Listen for auth state changes
    document.addEventListener('auth-state-changed', (e) => {
        if(e.detail && e.detail.signedIn) {
            document.body.classList.add('signed-in');
        } else {
            document.body.classList.remove('signed-in');
        }
    });
})();
</script>

<!-- Roll Number Format Guide Popup -->
<div id="rollno-guide-overlay" class="rollno-guide-overlay">
    <div class="rollno-guide-modal">
        <div class="rollno-guide-header">
            <div class="rollno-guide-icon">📋</div>
            <h3 class="rollno-guide-title">Roll Number Format Guide</h3>
        </div>
        <div class="rollno-guide-content">
            <p class="rollno-guide-desc">Please enter your roll number in the correct format:</p>
            <div class="rollno-format-example">
                <span class="rollno-format-text">123-R52-B</span>
            </div>
            <div class="rollno-guide-breakdown">
                <div class="rollno-part">
                    <span class="rollno-number">123</span>
                    <span class="rollno-label">Your class roll number</span>
                </div>
                <div class="rollno-separator">-</div>
                <div class="rollno-part">
                    <span class="rollno-number">R52</span>
                    <span class="rollno-label">Your RMU batch</span>
                </div>
                <div class="rollno-separator">-</div>
                <div class="rollno-part">
                    <span class="rollno-number">B</span>
                    <span class="rollno-label">Sub-batch (A, B, etc.)</span>
                </div>
            </div>
            <p class="rollno-guide-note">Example: Abdul Haseeb Ahmad would have 123-R52-B</p>
        </div>
        <div class="rollno-guide-actions">
            <button id="rollno-guide-ok" class="rollno-guide-btn">OK, Got it!</button>
        </div>
    </div>
</div>

<style>
/* Roll Number Guide Popup Styles */
.rollno-guide-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:10002;padding:20px;box-sizing:border-box}
.rollno-guide-modal{width:min(480px,95vw);max-height:90vh;background:#fff;border-radius:16px;border:2px solid #d4b071;box-shadow:0 20px 60px -12px rgba(110,28,23,.35);overflow-y:auto}
.rollno-guide-header{background:linear-gradient(135deg,#6e1c17,#55120f);color:#fff;padding:20px 24px;border-radius:14px 14px 0 0;text-align:center}
.rollno-guide-icon{font-size:32px;margin-bottom:8px}
.rollno-guide-title{font:700 20px Inter,system-ui,sans-serif;margin:0;letter-spacing:-0.3px}
.rollno-guide-content{padding:24px}
.rollno-guide-desc{font:14px/1.5 Inter,system-ui,sans-serif;color:#5d4037;margin:0 0 20px;text-align:center}
.rollno-format-example{background:#f8f4f0;border:2px solid #d4b071;border-radius:12px;padding:16px;text-align:center;margin-bottom:20px}
.rollno-format-text{font:700 24px 'Courier New',monospace;color:#6e1c17;letter-spacing:2px}
.rollno-guide-breakdown{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.rollno-part{display:flex;flex-direction:column;align-items:center;min-width:70px}
.rollno-number{font:600 18px 'Courier New',monospace;color:#6e1c17;background:#fef7f0;border:1px solid #d4b071;border-radius:8px;padding:8px 12px;margin-bottom:6px}
.rollno-label{font:11px Inter,system-ui,sans-serif;color:#8b4513;text-align:center;line-height:1.3}
.rollno-separator{font:700 20px Inter,system-ui,sans-serif;color:#d4b071;margin:0 4px}
.rollno-guide-note{font:12px/1.4 Inter,system-ui,sans-serif;color:#8b4513;text-align:center;background:#fff8f0;border:1px solid #f0e6d2;border-radius:8px;padding:12px;margin:0}
.rollno-guide-actions{padding:20px 24px;text-align:center;border-top:1px solid #f0e6d2}
.rollno-guide-btn{appearance:none;border:0;border-radius:10px;padding:12px 28px;font:600 14px Inter,system-ui,sans-serif;background:linear-gradient(135deg,#6e1c17,#55120f);color:#fff;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px -4px rgba(110,28,23,.4)}
.rollno-guide-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px -4px rgba(110,28,23,.5)}
.rollno-guide-btn:active{transform:translateY(0)}

/* Mobile responsive adjustments */
@media (max-width: 600px) {
  .rollno-guide-modal{width:95vw;margin:10px}
  .rollno-guide-breakdown{flex-direction:column;gap:12px}
  .rollno-format-text{font-size:20px;letter-spacing:1px}
  .rollno-number{font-size:16px;padding:6px 10px}
  .rollno-separator{transform:rotate(90deg);margin:8px 0}
}
</style>

<script>
(function() {
    'use strict';
    
    console.log('[RollNo] Initializing roll number validation system');
    
    // Roll number format validation (function already defined globally above)
    
    // Show roll number format guide popup
    function showRollNoGuide() {
        console.log('[RollNo] Showing guidance popup for invalid format');
        const overlay = document.getElementById('rollno-guide-overlay');
        if(overlay) {
            overlay.style.display = 'flex';
            // Add slight delay for smooth animation
            setTimeout(() => overlay.classList.add('show'), 10);
            console.log('[RollNo] Popup displayed successfully');
        } else {
            console.error('[RollNo] Popup overlay element not found!');
        }
    }
    
    // Hide roll number format guide popup
    function hideRollNoGuide() {
        console.log('[RollNo] Hiding guidance popup');
        const overlay = document.getElementById('rollno-guide-overlay');
        if(overlay) {
            overlay.classList.remove('show');
            setTimeout(() => overlay.style.display = 'none', 200);
        }
    }
    
    // Initialize popup event handlers when DOM is ready
    function initializePopup() {
        console.log('[RollNo] Setting up popup event handlers');
        
        const okBtn = document.getElementById('rollno-guide-ok');
        if(okBtn) {
            okBtn.addEventListener('click', function() {
                console.log('[RollNo] OK button clicked');
                hideRollNoGuide();
            });
        } else {
            console.error('[RollNo] OK button not found');
        }
        
        // Close popup when clicking outside
        const overlay = document.getElementById('rollno-guide-overlay');
        if(overlay) {
            overlay.addEventListener('click', function(e) {
                if(e.target === overlay) {
                    console.log('[RollNo] Clicked outside popup, closing');
                    hideRollNoGuide();
                }
            });
        }
    }
    
    // Export functions for use by portfolio.js
    window.rollNoValidator = {
        isValid: isValidRollNoFormat,
        showGuide: showRollNoGuide,
        hideGuide: hideRollNoGuide
    };
    
    console.log('[RollNo] Roll number validator initialized:', window.rollNoValidator);
    
    // Test validation function
    console.log('[RollNo] Testing validator with valid format 123-R52-B:', window.rollNoValidator.isValid('123-R52-B'));
    console.log('[RollNo] Testing validator with invalid format 123:', window.rollNoValidator.isValid('123'));
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePopup);
    } else {
        initializePopup();
    }
    
})();
</script>

</body>
</html>
