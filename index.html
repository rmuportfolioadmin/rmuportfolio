<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio Gallery</title>
  <meta name="description" content="Gallery of medical student portfolios" />
  <link rel="icon" type="image/png" href="RMUlogo.png" />
  <link rel="stylesheet" href="gallery.css?v=20250928.1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}</style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="config.js" defer></script>
  <script src="auth.js" defer></script>
  <script src="gallery.js" defer></script>
</head>
<body>
  <header class="gal-header">
    <div class="gal-container gal-header-inner">
      <div class="rmu-brand">
        <img src="RMUlogo.png" alt="Rawalpindi Medical University Logo" loading="lazy" />
        <div class="rmu-text">
          <div class="rmu-university">RAWALPINDI MEDICAL UNIVERSITY</div>
          <div class="rmu-sub">PORTFOLIO GALLERY</div>
        </div>
      </div>
      <h1 class="gal-title">Portfolio Gallery <small>Academic Archive</small></h1>
      <div class="gal-search-wrapper">
        <input id="search-box" type="search" placeholder="Search by name..." aria-label="Search portfolios" autocomplete="off" />
        <label style="display:inline-flex;align-items:center;gap:6px;margin-left:12px;font-size:12px;color:var(--gal-accent-alt);cursor:pointer;">
          <input type="checkbox" id="scan-toggle" checked style="accent-color:var(--gal-accent);"> Auto Scan
        </label>
        <div id="admin-controls" style="display:none;margin-left:12px;">
          <button id="admin-refresh" class="admin-btn" style="display:none;">üîÑ Refresh</button>
          <span id="admin-status" style="font-size:11px;color:var(--gal-accent);margin-left:8px;"></span>
        </div>
      </div>
    </div>
  </header>

  <main class="gal-main gal-container">
    <div id="status-bar" class="gal-status" role="status" aria-live="polite">Loading portfolios...</div>
    <div id="scan-progress" style="height:6px;border-radius:4px;background:#d4dde7;overflow:hidden;position:relative;display:none;margin:-4px 0 14px;">
      <div id="scan-progress-bar" style="height:100%;width:0;background:linear-gradient(90deg,#0a66c2,#2b79ff);transition:width .35s ease;filter:saturate(1.2);"></div>
    </div>
    <div id="gallery-grid" class="gal-grid" aria-label="Portfolio list" role="list"></div>
  </main>

  <footer class="gal-footer">
    <div class="gal-container">
      <small>&copy; <span id="year"></span> RMU Portfolio Gallery. <span id="count"></span></small>
    </div>
  </footer>

  <script src="gallery.js?v=20250928.1"></script>
  <script>document.getElementById('year').textContent=new Date().getFullYear();</script>

  <!-- VC Admin Mode Integration -->
  <style>
    .admin-btn{appearance:none;border:1px solid #d4dde7;border-radius:8px;padding:6px 12px;font:500 11px Inter,system-ui,sans-serif;background:#f8fafc;color:#0a66c2;cursor:pointer;transition:all 0.2s ease}
    .admin-btn:hover{background:#e8f4ff;border-color:#0a66c2}
    .admin-btn:disabled{opacity:0.5;cursor:not-allowed}
    .admin-overlay{position:fixed;inset:0;background:rgba(10,20,40,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:10000}
    .admin-modal{width:min(400px,90vw);background:#fff;border-radius:16px;box-shadow:0 20px 60px -12px rgba(0,0,0,.25);padding:24px}
    .admin-title{font:600 18px Inter,system-ui,sans-serif;color:#0b2340;margin:0 0 12px}
    .admin-desc{font:14px/1.5 Inter,system-ui,sans-serif;color:#3a4b61;margin-bottom:20px}
    .admin-actions{display:flex;gap:10px;justify-content:flex-end}
    .admin-modal-btn{appearance:none;border:0;border-radius:10px;padding:10px 16px;font:600 13px Inter,system-ui,sans-serif;cursor:pointer}
    .admin-modal-primary{background:linear-gradient(90deg,#0a66c2,#2b79ff);color:#fff;box-shadow:0 4px 12px -4px rgba(10,70,150,.4)}
    .admin-modal-ghost{background:#f3f6fb;color:#0b2340}
    .admin-error{color:#dc2626;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:8px 12px;font:12px Inter,system-ui,sans-serif;display:none;margin-bottom:12px}
    .gal-badge-local{background:#22c55e !important;color:#fff !important}
    .gal-badge-remote{background:#f59e0b !important;color:#fff !important}
    body.admin-mode .gal-title small::after{content:' ‚Ä¢ Admin Mode';color:#0a66c2;font-weight:600}
    body.admin-mode #gallery-grid .gal-row{cursor:pointer}
    body.admin-mode #gallery-grid .gal-row:hover{transform:translateY(-2px);box-shadow:0 8px 25px -8px rgba(10,70,150,.25)}
    
    /* Welcome Modal Styles */
    .welcome-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:saturate(1.2) blur(8px);display:none;align-items:center;justify-content:center;z-index:10001}
    .welcome-modal{width:min(560px,92vw);background:#fff;border-radius:20px;border:2px solid #d4b071;box-shadow:0 32px 80px -16px rgba(110,28,23,.45);padding:32px;text-align:center}
    .welcome-header{margin-bottom:24px}
    .welcome-logo{width:80px;height:80px;margin:0 auto 16px;border-radius:16px;background:linear-gradient(135deg,#6e1c17,#55120f);display:flex;align-items:center;justify-content:center;font-size:36px;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.3)}
    .welcome-title{font:700 24px Inter,system-ui,sans-serif;color:#6e1c17;margin:0 0 8px;letter-spacing:-0.5px}
    .welcome-subtitle{font:500 16px Inter,system-ui,sans-serif;color:#8b4513;margin:0 0 20px}
    .welcome-desc{font:14px/1.6 Inter,system-ui,sans-serif;color:#5d4037;margin-bottom:28px;max-width:460px;margin-left:auto;margin-right:auto}
    .welcome-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .welcome-btn{appearance:none;border:0;border-radius:12px;padding:12px 20px;font:600 14px Inter,system-ui,sans-serif;cursor:pointer;transition:all 0.3s ease;min-width:140px;position:relative;overflow:hidden}
    .welcome-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left 0.5s ease;z-index:1}
    .welcome-btn:hover::before{left:100%}
    .welcome-btn-primary{background:linear-gradient(135deg,#6e1c17 0%,#55120f 100%);color:#fff;box-shadow:0 8px 24px -8px rgba(110,28,23,.4);border:2px solid #55120f}
    .welcome-btn-primary:hover{transform:translateY(-2px);box-shadow:0 12px 32px -8px rgba(110,28,23,.5)}
    .welcome-btn-ghost{background:rgba(110,28,23,.08);color:#6e1c17;border:2px solid #d4b071}
    .welcome-btn-ghost:hover{background:rgba(110,28,23,.15);transform:translateY(-1px)}
    .welcome-btn-icon{margin-right:8px;font-size:16px}
    .loading-dots{display:none;align-items:center;justify-content:center;margin-top:16px;font:14px Inter,system-ui,sans-serif;color:#8b4513}
    .loading-dots::after{content:'';margin-left:4px;animation:loadingDots 1.4s ease-in-out infinite both}
    @keyframes loadingDots{0%,80%,100%{opacity:0}40%{opacity:1}}
    
    /* Portfolio Blur Effect */
    body.portfolio-blurred .gal-main{filter:blur(8px) brightness(0.7);pointer-events:none;transition:all 0.4s ease}
    body.portfolio-loaded .gal-main{filter:none;pointer-events:auto;transition:all 0.4s ease}
    
    /* Hidden Gallery Mode */
    body.hide-gallery-nav .back-to-gallery{display:none !important}
  </style>

  <!-- Welcome Modal with Authentication Options -->
  <div id="welcome-overlay" class="welcome-overlay" style="display:flex;">
    <div class="welcome-modal">
      <div class="welcome-header">
        <div class="welcome-logo">
          <img src="RMUlogo.png" alt="RMU Logo" style="width:60px;height:60px;object-fit:contain;"/>
        </div>
        <h1 class="welcome-title">Welcome to RMU Portfolio</h1>
        <p class="welcome-subtitle">Rawalpindi Medical University</p>
      </div>
      <div id="welcome-error" class="admin-error" style="display:none;"></div>
      <p class="welcome-desc">
        Your digital academic portfolio is ready to explore. Sign in with Google to access your personal data and sync across devices, or continue without signing in to view the demo portfolio. <small style="display:block;margin-top:8px;opacity:0.7;">Note: Google authentication is being updated to comply with new security requirements.</small>
      </p>
      <div class="welcome-actions">
        <button id="welcome-signin" class="welcome-btn welcome-btn-primary">
          <span class="welcome-btn-icon">üîë</span>Sign in with Google
        </button>
        <button id="welcome-continue" class="welcome-btn welcome-btn-ghost">
          <span class="welcome-btn-icon">üìù</span>Continue without sign in
        </button>
      </div>
      <div id="welcome-loading" class="welcome-loading" style="display:none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading portfolio data...</div>
      </div>
    </div>
  </div>
  
  <!-- Admin Sign-In Modal (kept for compatibility) -->
  <div id="admin-overlay" class="admin-overlay" style="display:none;">
    <div class="admin-modal">
      <div class="admin-title">Administrator Access</div>
      <div id="admin-error" class="admin-error"></div>
      <div class="admin-desc">Sign in with the authorized Google account to access the portfolio management system.</div>
      <div class="admin-actions">
        <button id="admin-cancel" class="admin-modal-btn admin-modal-ghost">Cancel</button>
        <button id="admin-signin-confirm" class="admin-modal-btn admin-modal-primary">Sign In with Google</button>
      </div>
    </div>
  </div>

  <script>
  // Auto-generate files.json from data folder (utility function - defined early to avoid undefined errors)
  async function generateFilesIndex() {
    console.log('[Admin] Generating files.json content from data folder...');
    const dataFiles = [];
    const knownFiles = ['affans-medico-file-52.json','aieshas-medfolio-06-52.json','aliza-altaf-khans-16-R52-medfolio.json','aminah-liaqats-medfolio-R51.json','ans-javeds-medfolio.json','azharkhans-252-52-medfolio.json','calypsos-medfolio.json','eman-tariq-71-51-medfolio.json','fahmeeda-umers-56-52-medfolio.json','faiqa-farooqs-73-51-medfolio.json','fatima-aneess-63-R52medfolio .json','fatima-safdars-79-51-medfolio.json','hadia-khans-85-51-medfolio .json','hadia-mubashars-67-R52-portfolio.json','hadia-tanveers-87-51-portfolio.json','haiqa-munirs-91-51-medfolio.json','hassan-mehmood-221-R52.json','Ibrahim Shafi 280.json','kaleems-medfolio.json','marium-saleem-52B-105.json','mbks-medfolio-231-R52.json','muneeba-tehreems-medfolio .json','saidullah-280-R52.json','salwa-jannats-184-52-medfolio.json','saman-zahras-185-52medfolio.json','sattars-medfolio.json','Summaya-Muhammad-194-R52-medfolio.json','tehreem-durranis-medfolio.json','tehreem-durranis-R51-medfolio.json','wajiha-beintias-204-52-medfolio .json','waleejas-205-52-medfolio .json','zabu-bakar-saddique-medfolio.json','zabu-bakars-medfolio.json','zoha-saleems--214-52-medfolio.json'];
    for(const filename of knownFiles) {
      try {
        const response = await fetch(`./data/${filename}`, { method: 'HEAD' });
        if(response.ok) dataFiles.push({ file: `data/${filename}`, name: filename.replace(/\.json$/, '') });
      } catch(err) {}
    }
    console.log(`%c[Admin] Found ${dataFiles.length} valid files`, 'color:green;font-weight:bold');
    console.log('%cfiles.json content:', 'color:blue;font-weight:bold');
    console.log(JSON.stringify(dataFiles, null, 2));
    return dataFiles;
  }

  // Portfolio Welcome & Authentication System
  (function() {
    const ADMIN_EMAIL = 'rmuportfolioa@gmail.com';
    let isAdminMode = false;
    let isSignedIn = false;
    let adminToken = null;
    let currentUserEmail = null;
    
    const elements = {
      adminControls: document.getElementById('admin-controls'),
      adminRefresh: document.getElementById('admin-refresh'),
      adminStatus: document.getElementById('admin-status'),
      adminOverlay: document.getElementById('admin-overlay'),
      adminError: document.getElementById('admin-error'),
      adminCancel: document.getElementById('admin-cancel'),
      adminSigninConfirm: document.getElementById('admin-signin-confirm'),
      galleryGrid: document.getElementById('gallery-grid'),
      statusBar: document.getElementById('status-bar'),
      searchBox: document.getElementById('search-box'),
      scanToggle: document.getElementById('scan-toggle'),
      welcomeOverlay: document.getElementById('welcome-overlay'),
      welcomeError: document.getElementById('welcome-error'),
      welcomeSignin: document.getElementById('welcome-signin'),
      welcomeContinue: document.getElementById('welcome-continue'),
      welcomeLoading: document.getElementById('welcome-loading')
    };
    
    function showAdminOverlay(show) {
      if(elements.adminOverlay) elements.adminOverlay.style.display = show ? 'flex' : 'none';
    }
    
    function setAdminError(msg) {
      if(elements.adminError) {
        elements.adminError.textContent = msg || '';
        elements.adminError.style.display = msg ? 'block' : 'none';
      }
    }
    
    function setAdminStatus(msg) {
      if(elements.adminStatus) elements.adminStatus.textContent = msg || '';
    }
    
    function setStatus(msg) {
      if(elements.statusBar) elements.statusBar.textContent = msg;
    }
    
    function showWelcomeOverlay(show) {
      if(elements.welcomeOverlay) elements.welcomeOverlay.style.display = show ? 'flex' : 'none';
    }
    
    function setWelcomeError(msg) {
      if(elements.welcomeError) {
        elements.welcomeError.textContent = msg || '';
        elements.welcomeError.style.display = msg ? 'block' : 'none';
      }
    }
    
    function showWelcomeLoading(show, message) {
      if(elements.welcomeLoading) {
        elements.welcomeLoading.style.display = show ? 'flex' : 'none';
        const loadingText = elements.welcomeLoading.querySelector('.loading-text');
        if(loadingText && message) {
          loadingText.textContent = message;
        }
      }
    }
    
    function blurPortfolio(blur) {
      document.body.classList.toggle('portfolio-blurred', blur);
      document.body.classList.toggle('portfolio-loaded', !blur);
    }
    
    function hideGalleryNavigation(hide) {
      document.body.classList.toggle('hide-gallery-nav', hide);
    }
    
    function enableAdminMode() {
      isAdminMode = true;
      document.body.classList.add('admin-mode');
      if(elements.adminControls) elements.adminControls.style.display = 'block';
      if(elements.adminSignin) elements.adminSignin.style.display = 'none';
      if(elements.adminRefresh) elements.adminRefresh.style.display = 'inline-block';
      if(elements.scanToggle) elements.scanToggle.checked = false; // Disable auto scan in admin mode
      setAdminStatus('Admin');
      loadAdminPortfolios();
    }
    
    function disableAdminMode() {
      isAdminMode = false;
      adminToken = null;
      document.body.classList.remove('admin-mode');
      if(elements.adminControls) elements.adminControls.style.display = 'none';
      setAdminStatus('');
      // Restore normal gallery functionality
      if(window.loadGallery) window.loadGallery();
    }
    
    async function signInFromWelcome() {
      try {
        showWelcomeLoading(true);
        setWelcomeError('');
        
        console.log('[Welcome] Starting authentication...');
        
        // Wait for RMU_AUTH to be ready
        if (!window.RMU_AUTH) {
          console.log('[Welcome] Waiting for RMU_AUTH...');
          await new Promise(resolve => {
            if (window.RMU_AUTH) {
              resolve();
            } else {
              document.addEventListener('auth-ready', resolve, { once: true });
            }
          });
        }
        
        // Use the modernized auth system with fallback
        try {
          const authResult = await window.RMU_AUTH.authenticateUser();
          
          adminToken = authResult.token;
          currentUserEmail = authResult.email;
          isSignedIn = true;
        } catch (authError) {
          console.warn('[Welcome] Modern auth failed, providing fallback:', authError);
          
          // Graceful fallback - continue without auth but inform user
          setWelcomeError('Google Sign-In is currently updating to new security standards. You can browse portfolios without signing in.');
          
          setTimeout(() => {
            continueWithoutSignIn();
          }, 3000);
          return;
        }
        
        if(!adminToken) {
          setWelcomeError('Failed to obtain authentication token');
          showWelcomeLoading(false);
          return;
        }
        
        // Check if admin or regular user
        if(currentUserEmail?.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
          // VC/Admin user - show loading and enable admin mode with backend integration
          console.log('[Auth] VC email detected - activating admin mode with backend integration');
          setStatus('VC authenticated - Initializing gallery...');
          showWelcomeLoading(true, 'Scanning portfolios from Google Drive...');
          
          try {
            // Activate backend to scan Drive and create files.json
            await initializeVCGallery(adminToken);
            showWelcomeOverlay(false);
            blurPortfolio(false);
            enableAdminMode();
            showWelcomeLoading(false);
          } catch(err) {
            console.error('[Auth] VC gallery initialization failed:', err);
            setWelcomeError('Failed to initialize VC gallery: ' + (err.message || err));
            showWelcomeLoading(false);
          }
        } else {
          // Regular user - load their portfolio from Drive and hide gallery navigation
          console.log('[Auth] Regular user detected - loading user portfolio');
          showWelcomeOverlay(false);
          blurPortfolio(false);
          hideGalleryNavigation(true);
          loadUserPortfolioFromDrive(currentUserEmail, adminToken);
        }
        
        showWelcomeLoading(false);
        
      } catch(err) {
        console.error('Welcome sign-in error:', err);
        
        // Try fallback with simpler authentication flow
        try {
          console.log('[Auth] Trying fallback authentication method...');
          setWelcomeError('Retrying with alternative method...');
          
          await fallbackGoogleAuth();
          
        } catch(fallbackErr) {
          console.error('Fallback auth also failed:', fallbackErr);
          setWelcomeError('Sign-in failed. This may be due to browser restrictions or Google API changes. Please try refreshing the page or contact support.');
        }
        
        showWelcomeLoading(false);
      }
    }
    
    // Fallback authentication method
    async function fallbackGoogleAuth() {
      console.log('[Auth] Using fallback authentication...');
      
      // For now, just continue without authentication but show a message
      setWelcomeError('Authentication temporarily unavailable. Continuing with limited functionality...');
      
      // Wait a moment, then proceed
      setTimeout(() => {
        continueWithoutSignIn();
      }, 2000);
    }
    
    async function continueWithoutSignIn() {
      try {
        showWelcomeOverlay(false);
        blurPortfolio(false);
        hideGalleryNavigation(true);
        
        // Load the first available portfolio or portfolio-data.json
        await loadDefaultPortfolio();
        
      } catch(err) {
        console.error('Continue without sign-in error:', err);
      }
    }
    
    async function initializeVCGallery(token) {
      console.log('[VC] Initializing VC gallery with backend integration');
      const config = window.RMU_CONFIG || {};
      const backendBase = (config.BACKEND_BASE || '').replace(/\/$/, '');
      
      if (!backendBase || config.IS_LOCALHOST) {
        console.log('[VC] Backend not configured or localhost - using local data only');
        return;
      }
      
      try {
        console.log('[VC] Requesting backend to scan Drive and generate files.json');
        setStatus('Backend scanning Google Drive...');
        
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        const response = await fetch(`${backendBase}/api/generate-manifest`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          credentials: 'omit',
          cache: 'no-store',
          signal: controller.signal
        });
        
        clearTimeout(timeout);
        
        if (response.ok) {
          const result = await response.json();
          console.log('[VC] Backend manifest generation result:', result);
          setStatus(`Found ${result.count || 0} portfolios in Drive`);
        } else {
          const errorText = await response.text().catch(() => response.statusText);
          console.warn('[VC] Backend manifest generation failed:', errorText);
          setStatus('Drive scan completed with warnings');
        }
        
      } catch (err) {
        console.error('[VC] Backend initialization error:', err);
        setStatus('Using local data - backend unavailable');
        // Don't throw - allow fallback to local data
      }
    }

    async function loadAdminPortfolios() {
      try {
        if(!adminToken) {
          setStatus('Not authenticated for admin access');
          return;
        }
        
        console.log('[Admin] Loading portfolios in hybrid mode (local + remote)');
        setStatus('Loading portfolios...');
        
        let localPortfolios = [];
        let remotePortfolios = [];
        
        // 1. First, try to load local files.json (current gallery data)
        try {
          console.log('[Admin] Loading local files.json');
          const filesResp = await fetch('./files.json?t=' + Date.now(), { cache: 'no-store' });
          if(filesResp.ok) {
            const filesData = await filesResp.json();
            if(Array.isArray(filesData)) {
              localPortfolios = filesData.map(item => ({
                id: `local_${item.file}`,
                file: item.name || item.file.replace(/^data\//, '').replace(/\.json$/, ''),
                roll: extractRollFromFilename(item.file),
                email: '',
                updatedAt: 'Local File',
                source: 'local',
                localPath: item.file
              }));
              console.log(`[Admin] Loaded ${localPortfolios.length} local portfolios`);
            }
          }
        } catch(err) {
          console.log('[Admin] files.json not available, will try data folder scan');
        }
        
        // 2. If no local files.json, scan data folder directly
        if(localPortfolios.length === 0) {
          console.log('[Admin] Scanning data folder for JSON files');
          localPortfolios = await scanLocalDataFolder();
        }
        
        // 3. Try to load remote portfolios from backend (Google Drive)
        const config = window.RMU_CONFIG || {};
        const backendBase = (config.BACKEND_BASE || '').replace(/\/$/, '');
        
        if(backendBase && !config.IS_LOCALHOST) {
          try {
            console.log('[Admin] Loading portfolios from Google Drive via backend');
            setStatus('Loading Drive portfolios...');
            
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), config.API_TIMEOUT || 20000);
            
            const response = await fetch(`${backendBase}/api/list`, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${adminToken}`,
                'Content-Type': 'application/json'
              },
              credentials: 'omit',
              cache: 'no-store',
              signal: controller.signal
            });
            
            clearTimeout(timeout);
            
            if(response.ok) {
              const backendData = await response.json();
              if(Array.isArray(backendData)) {
                remotePortfolios = backendData.map(item => ({
                  id: item.id || `drive_${item.file}`,
                  file: item.file,
                  name: extractDisplayName(item.file, item.roll, item.email),
                  roll: item.roll || '',
                  email: item.email || '',
                  updatedAt: item.updatedAt || 'Unknown',
                  source: 'drive',
                  driveId: item.id
                }));
                console.log(`[Admin] Loaded ${remotePortfolios.length} portfolios from Google Drive`);
              }
            } else {
              console.log(`[Admin] Backend returned ${response.status}, using local data only`);
            }
          } catch(err) {
            console.log('[Admin] Backend unavailable for Drive access:', err.message);
          }
        } else {
          console.log('[Admin] Backend not configured or localhost - using local data only');
        }
        
        // 4. Combine and display portfolios
        const allPortfolios = [...localPortfolios, ...remotePortfolios];
        
        if(allPortfolios.length === 0) {
          setStatus('No portfolios found (local or remote)');
          if(elements.galleryGrid) elements.galleryGrid.innerHTML = '';
          return;
        }
        
        console.log(`[Admin] Total portfolios: ${allPortfolios.length} (${localPortfolios.length} local, ${remotePortfolios.length} remote)`);
        displayAdminPortfolios(allPortfolios);
        
      } catch(err) {
        console.error('[Admin] Load portfolios error:', err);
        setStatus('Failed to load portfolios: ' + (err.message || err));
      }
    }
    
    // Helper function to extract roll number from filename
    function extractRollFromFilename(filename) {
      const rollPatterns = [
        /-(\d{1,3}-?[RS]?\d{2})/i,  // -123-R52, -52-R52, etc.
        /[_-](\d{3})[^\d]/i,        // _280, -221, etc.
        /[_-]([RS]\d{2})/i          // -R52, _R51, etc.
      ];
      
      for(const pattern of rollPatterns) {
        const match = filename.match(pattern);
        if(match) return match[1].toUpperCase();
      }
      return '';
    }
    
    // Helper function to extract display name from filename
    function extractDisplayName(filename, rollNo, email) {
      // Remove .json extension and common suffixes
      let name = filename.replace(/\.json$/i, '')
                        .replace(/-?(medfolio|portfolio|file)$/i, '')
                        .replace(/-?R?\d{2}$/i, '');
      
      // Replace separators with spaces and clean up
      name = name.replace(/[-_]+/g, ' ')
                 .replace(/\s+/g, ' ')
                 .trim();
      
      // Capitalize words
      name = name.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
      
      // If we have roll number, append it
      if (rollNo) {
        name += ` (${rollNo})`;
      }
      
      return name || filename.replace(/\.json$/i, '');
    }
    
    // Scan local data folder for JSON files
    async function scanLocalDataFolder() {
      const localFiles = [];
      
      // Try common filename patterns from the data folder
      const knownFiles = [
        'affans-medico-file-52.json', 'aieshas-medfolio-06-52.json', 'aliza-altaf-khans-16-R52-medfolio.json',
        'aminah-liaqats-medfolio-R51.json', 'ans-javeds-medfolio.json', 'azharkhans-252-52-medfolio.json',
        'calypsos-medfolio.json', 'eman-tariq-71-51-medfolio.json', 'fahmeeda-umers-56-52-medfolio.json',
        'faiqa-farooqs-73-51-medfolio.json', 'fatima-aneess-63-R52medfolio .json', 'fatima-safdars-79-51-medfolio.json',
        'hadia-khans-85-51-medfolio .json', 'hadia-mubashars-67-R52-portfolio.json', 'hadia-tanveers-87-51-portfolio.json',
        'haiqa-munirs-91-51-medfolio.json', 'hassan-mehmood-221-R52.json', 'Ibrahim Shafi 280.json',
        'kaleems-medfolio.json', 'marium-saleem-52B-105.json', 'mbks-medfolio-231-R52.json',
        'muneeba-tehreems-medfolio .json', 'saidullah-280-R52.json', 'salwa-jannats-184-52-medfolio.json',
        'saman-zahras-185-52medfolio.json', 'sattars-medfolio.json', 'Summaya-Muhammad-194-R52-medfolio.json',
        'tehreem-durranis-medfolio.json', 'tehreem-durranis-R51-medfolio.json', 'wajiha-beintias-204-52-medfolio .json',
        'waleejas-205-52-medfolio .json', 'zabu-bakar-saddique-medfolio.json', 'zabu-bakars-medfolio.json',
        'zoha-saleems--214-52-medfolio.json'
      ];
      
      for(const filename of knownFiles) {
        try {
          const response = await fetch(`./data/${filename}`, { method: 'HEAD' });
          if(response.ok) {
            localFiles.push({
              id: `local_data_${filename}`,
              file: filename.replace(/\.json$/, ''),
              roll: extractRollFromFilename(filename),
              email: '',
              updatedAt: 'Local File',
              source: 'local',
              localPath: `data/${filename}`
            });
          }
        } catch(err) {
          // File doesn't exist, continue
        }
      }
      
      console.log(`[Admin] Found ${localFiles.length} files in data folder scan`);
      return localFiles;
    }
    
    function displayAdminPortfolios(portfolios) {
      if(!elements.galleryGrid) return;
      
      elements.galleryGrid.innerHTML = '';
      
      if(!portfolios || portfolios.length === 0) {
        setStatus('No portfolios found (local or remote)');
        return;
      }
      
      const localCount = portfolios.filter(p => p.source === 'local').length;
      const remoteCount = portfolios.filter(p => p.source === 'remote').length;
      
      let statusMsg = `Found ${portfolios.length} portfolio${portfolios.length !== 1 ? 's' : ''}`;
      if(localCount > 0 && remoteCount > 0) {
        statusMsg += ` (${localCount} local, ${remoteCount} remote)`;
      } else if(localCount > 0) {
        statusMsg += ` (local files)`;
      } else if(remoteCount > 0) {
        statusMsg += ` (remote files)`;
      }
      
      setStatus(statusMsg);
      
      portfolios.forEach((portfolio, index) => {
        const row = document.createElement('div');
        row.className = 'gal-row';
        row.setAttribute('data-file-id', portfolio.id);
        row.setAttribute('data-filename', portfolio.file);
        row.setAttribute('data-source', portfolio.source);
        
        // Extract name from filename or use roll/email
        const displayName = extractDisplayName(portfolio.file, portfolio.roll, portfolio.email);
        const rollNumber = portfolio.roll || 'N/A';
        const lastUpdated = portfolio.updatedAt === 'Local File' ? 'Local File' : 
                           portfolio.updatedAt ? new Date(portfolio.updatedAt).toLocaleDateString() : 'Unknown';
        
        // Source badge
        const sourceBadge = portfolio.source === 'local' ? 
          '<span class="gal-badge gal-badge-local">Local</span>' :
          '<span class="gal-badge gal-badge-remote">Remote</span>';
        
        row.innerHTML = `
          <div class="gal-avatar">${getInitials(displayName)}</div>
          <div class="gal-info">
            <div class="gal-name">${displayName}</div>
            <div class="gal-meta">Roll: ${rollNumber} ‚Ä¢ Updated: ${lastUpdated}</div>
          </div>
          <div class="gal-actions">
            ${sourceBadge}
          </div>
        `;
        
        // Add click handler to load portfolio
        row.addEventListener('click', () => loadPortfolioAdmin(portfolio));
        
        elements.galleryGrid.appendChild(row);
      });
      
      // Enable search filtering
      if(elements.searchBox) {
        elements.searchBox.oninput = () => filterAdminPortfolios(elements.searchBox.value);
      }
    }
    
    function extractDisplayName(filename, roll, email) {
      // Remove .json extension
      let name = filename.replace(/\.json$/i, '');
      
      // If filename contains underscore, take the part before roll number
      if(roll && name.includes('_' + roll)) {
        name = name.split('_' + roll)[0];
      }
      
      // Convert underscores to spaces and title case
      name = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      
      return name || roll || email || 'Unknown';
    }
    
    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').substr(0, 2).toUpperCase();
    }
    
    function filterAdminPortfolios(query) {
      if(!elements.galleryGrid) return;
      
      const rows = elements.galleryGrid.querySelectorAll('.gal-row');
      let visibleCount = 0;
      
      rows.forEach(row => {
        const name = row.querySelector('.gal-name')?.textContent || '';
        const meta = row.querySelector('.gal-meta')?.textContent || '';
        const searchText = (name + ' ' + meta).toLowerCase();
        const matches = !query || searchText.includes(query.toLowerCase());
        
        row.style.display = matches ? 'flex' : 'none';
        if(matches) visibleCount++;
      });
      
      setStatus(query ? `${visibleCount} portfolio${visibleCount !== 1 ? 's' : ''} match "${query}"` : `${visibleCount} portfolio${visibleCount !== 1 ? 's' : ''}`);
    }
    
    async function loadPortfolioAdmin(portfolio) {
      try {
        setStatus(`Loading ${portfolio.file}...`);
        
        if(portfolio.source === 'local') {
          // Load local portfolio file
          const localPath = portfolio.localPath || `data/${portfolio.file}.json`;
          const url = `portfolio.html?file=${encodeURIComponent(localPath)}&admin=1`;
          window.open(url, '_blank');
          setStatus('Local portfolio opened in new tab');
          
        } else if(portfolio.source === 'remote') {
          // Load remote portfolio from backend
          const config = window.RMU_CONFIG || {};
          const backendBase = (config.BACKEND_BASE || '').replace(/\/$/, '');
          
          if(!backendBase) {
            throw new Error('Backend not configured');
          }
          
          const response = await fetch(`${backendBase}/api/download?id=${encodeURIComponent(portfolio.id)}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${adminToken}`,
              'Content-Type': 'application/json'
            },
            credentials: 'omit',
            cache: 'no-store'
          });
          
          if(!response.ok) {
            throw new Error(`Failed to download remote portfolio: ${response.status}`);
          }
          
          const portfolioData = await response.json();
          
          // Open portfolio in new tab/window with the data
          const url = `portfolio.html?admin=1&remote=1&file=${encodeURIComponent(portfolio.file)}`;
          const portfolioWindow = window.open(url, '_blank');
          
          // Pass the data to the new window with retry mechanism
          if(portfolioWindow) {
            const sendData = () => {
              try {
                portfolioWindow.postMessage({
                  type: 'admin-portfolio-data',
                  data: portfolioData,
                  filename: portfolio.file,
                  source: 'remote'
                }, '*');
                console.log('[Admin] Portfolio data sent to new window');
              } catch(err) {
                console.warn('[Admin] Failed to send portfolio data:', err);
              }
            };
            
            // Try multiple approaches to ensure message is received
            // 1. Try immediately (might work if window loads fast)
            setTimeout(sendData, 100);
            
            // 2. Try on load event
            portfolioWindow.addEventListener('load', sendData);
            
            // 3. Try on DOM ready
            const checkAndSend = setInterval(() => {
              try {
                if (portfolioWindow.document && portfolioWindow.document.readyState === 'complete') {
                  sendData();
                  clearInterval(checkAndSend);
                }
              } catch(err) {
                // Cross-origin access might be blocked, that's ok
              }
            }, 200);
            
            // 4. Stop trying after 10 seconds
            setTimeout(() => clearInterval(checkAndSend), 10000);
          }
          
          setStatus('Remote portfolio opened in new tab');
        }
        
      } catch(err) {
        console.error('Load portfolio error:', err);
        setStatus('Failed to load portfolio: ' + (err.message || err));
      }
    }
    
    async function loadDefaultPortfolio() {
      try {
        // Try portfolio-data.json first
        let portfolioUrl = './portfolio-data.json';
        let response = await fetch(portfolioUrl, { cache: 'no-store' });
        
        if(!response.ok) {
          // If portfolio-data.json not found, try first file from files.json
          const filesResp = await fetch('./files.json?t=' + Date.now(), { cache: 'no-store' });
          if(filesResp.ok) {
            const filesData = await filesResp.json();
            if(Array.isArray(filesData) && filesData.length > 0) {
              portfolioUrl = './' + filesData[0].file;
            }
          }
        }
        
        // Open the portfolio in the same window
        window.location.href = `portfolio.html?file=${encodeURIComponent(portfolioUrl)}&welcome=1`;
        
      } catch(err) {
        console.error('Error loading default portfolio:', err);
        setStatus('Error loading default portfolio');
      }
    }
    
    async function loadUserPortfolioFromDrive(email, token) {
      try {
        const config = window.RMU_CONFIG || {};
        const backendBase = (config.BACKEND_BASE || '').replace(/\/$/, '');
        
        if(!backendBase) {
          console.log('Backend not configured, loading default portfolio');
          await loadDefaultPortfolio();
          return;
        }
        
        // Try to fetch user's portfolio from their Drive appData
        console.log(`Loading portfolio for user: ${email}`);
        setStatus('Loading your portfolio from Google Drive...');
        
        const response = await fetch(`${backendBase}/api/user-portfolio`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          credentials: 'omit',
          cache: 'no-store'
        });
        
        if(response.ok) {
          const portfolioData = await response.json();
          
          // Open portfolio with user data
          const portfolioWindow = window.open('portfolio.html?user=1&drive=1', '_self');
          
          // Pass the data to the window
          setTimeout(() => {
            window.postMessage({
              type: 'user-portfolio-data',
              data: portfolioData,
              email: email,
              source: 'drive'
            }, '*');
          }, 100);
          
        } else {
          console.log('User portfolio not found in Drive, loading default');
          await loadDefaultPortfolio();
        }
        
      } catch(err) {
        console.error('Error loading user portfolio from Drive:', err);
        console.log('Falling back to default portfolio');
        await loadDefaultPortfolio();
      }
    }
    
    // Event handlers
    elements.welcomeSignin?.addEventListener('click', signInFromWelcome);
    elements.welcomeContinue?.addEventListener('click', continueWithoutSignIn);
    
    elements.adminRefresh?.addEventListener('click', loadAdminPortfolios);
    elements.adminCancel?.addEventListener('click', () => showAdminOverlay(false));
    elements.adminSigninConfirm?.addEventListener('click', signInFromWelcome);
    
    // Initialize welcome system
    function init() {
      console.log('[Portfolio] Initializing welcome system...');
      console.log('[Portfolio] RMU_AUTH available:', !!window.RMU_AUTH);
      console.log('[Portfolio] RMU_CONFIG available:', !!window.RMU_CONFIG);
      
      // Start with blurred portfolio and welcome modal
      blurPortfolio(true);
      showWelcomeOverlay(true);
      
      // Pre-load the first portfolio in background
      loadDefaultPortfolioInBackground();
      
      // Check if already signed in
      if(window.RMU_AUTH && RMU_AUTH.getCurrentUserEmail()) {
        const email = RMU_AUTH.getCurrentUserEmail();
        console.log('[Portfolio] Already signed in as:', email);
        
        if(email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
          // Admin is already signed in
          RMU_AUTH.getIdToken().then(token => {
            if(token) {
              adminToken = token;
              currentUserEmail = email;
              isSignedIn = true;
              showWelcomeOverlay(false);
              blurPortfolio(false);
              enableAdminMode();
            }
          }).catch(console.error);
        } else {
          // Regular user is already signed in
          RMU_AUTH.getIdToken().then(token => {
            if(token) {
              adminToken = token;
              currentUserEmail = email;
              isSignedIn = true;
              showWelcomeOverlay(false);
              blurPortfolio(false);
              hideGalleryNavigation(true);
              loadUserPortfolioFromDrive(email, token);
            }
          }).catch(console.error);
        }
      }
    }
    
    async function loadDefaultPortfolioInBackground() {
      try {
        // Pre-load gallery data for smooth transition
        if(window.loadIndex) {
          window.loadIndex();
        }
      } catch(err) {
        console.log('[Portfolio] Background loading error:', err);
      }
    }
    
    // Test backend connectivity (works better on GitHub Pages)
    async function testBackend() {
      try {
        const config = window.RMU_CONFIG || {};
        const backendBase = config.BACKEND_BASE;
        console.log('[Admin] Testing backend:', backendBase);
        
        if(!backendBase) {
          console.error('[Admin] No BACKEND_BASE configured');
          return;
        }
        
        // Skip health check on localhost due to CORS
        if(window.location.hostname === 'localhost') {
          console.log('[Admin] Skipping backend test on localhost (CORS limitation)');
          console.log('[Admin] Backend will work when deployed to GitHub Pages');
          return;
        }
        
        // Test the root endpoint that we know works
        const response = await fetch(`${backendBase}/`, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-store'
        }).catch(err => {
          console.log('[Admin] Backend fetch error:', err.message);
          return null;
        });
        
        if(response) {
          console.log('[Admin] Backend responded with status:', response.status);
        } else {
          console.log('[Admin] Backend connection test completed');
        }
      } catch(err) {
        console.error('[Admin] Backend test error:', err);
      }
    }
    
    // Initialize when auth is ready
    if(window.RMU_AUTH) {
      init();
    } else {
      document.addEventListener('auth-ready', init);
    }
    
    // Test backend after a short delay
    setTimeout(testBackend, 2000);
    
    // Function already defined at the top of the file to avoid undefined errors
    
    // Expose for debugging
    window.portfolioSystem = { 
      isAdminMode, 
      isSignedIn, 
      currentUserEmail,
      loadAdminPortfolios, 
      enableAdminMode, 
      disableAdminMode, 
      testBackend, 
      generateFilesIndex: window.generateFilesIndex,
      signInFromWelcome,
      continueWithoutSignIn,
      loadDefaultPortfolio
    };
  })();
  </script>

</body>
</html>
